<div class="component-content" [class.height-ajust]="!bodyHide" style="position: relative;">
    @if (loading) {
        <div class="loading">
            <mat-spinner style="margin:auto;opacity: 0.2;" diameter="20"></mat-spinner>
        </div>
    }
    @if (msgToDisplay !== '') {
        <app-maarch-message [mode]="'danger'" [content]="msgToDisplay"></app-maarch-message>
    }
    @if (!senderHide) {
        <mat-form-field>
            <span matPrefix class="mailLabel">{{ 'lang.senderShort' | translate }}&nbsp;:&nbsp;</span>
            @if (senderDisabled) {
                <input matInput [value]="currentSender.email" disabled>
            }
            @if (!senderDisabled) {
                <mat-select [compareWith]="this.compareSenders" [(ngModel)]="currentSender">
                    @for (email of availableSenders | sortBy: 'label'; track email) {
                        <mat-option [value]="email">
                            {{ email.label }} ({{ email.email }})
                        </mat-option>
                    }
                </mat-select>
            }
            <button mat-button class="primary" matSuffix [disabled]="cCDisabled" [class.activeButton]="showCopies"
                    (click)="$event.stopPropagation();showCopies = !showCopies">{{ 'lang.copieShort' | translate }}
            </button>
            <button mat-button class="primary" matSuffix [disabled]="cCIDisabled"
                    [class.activeButton]="showInvisibleCopies"
                    (click)="$event.stopPropagation();showInvisibleCopies = !showInvisibleCopies">{{ 'lang.invisibleCopyShort' | translate }}
            </button>
        </mat-form-field>
    }
    @if (!recipientHide) {
        <mat-form-field>
            <span matPrefix class="mailLabel">{{ 'lang.recipientShort' | translate }}&nbsp;:&nbsp;</span>
            <mat-chip-list id="recipients-list" #recipientsList cdkDropList
                           [cdkDropListConnectedTo]="['copies-list','invcopies-list']" [cdkDropListData]="recipients"
                           (cdkDropListDropped)="drop($event)">
                @for (recipient of recipients; track recipient) {
                    <mat-chip cdkDrag [cdkDragDisabled]="recipientDisabled" class="recipients"
                              [removable]="!recipientDisabled"
                              (removed)="!recipientDisabled ? remove(recipient, 'recipients') : false"
                              (click)="!recipientDisabled ? remove(recipient, 'recipients') : false"
                              [title]="recipient.email"
                              [class.badFormat]="recipient.badFormat">
                        {{ recipient.label }}{{ recipient.label !== recipient.email ? ' (' + recipient.email + ')' : '' }}
                        @if (!recipientDisabled) {
                            <mat-icon matChipRemove class="fa fa-times"></mat-icon>
                        }
                    </mat-chip>
                }
                <input [formControl]="recipientsInput" #recipientsField [matChipInputFor]="recipientsList"
                       [matChipInputSeparatorKeyCodes]="separatorKeysCodes" [matChipInputAddOnBlur]="true"
                       (matChipInputTokenEnd)="add($event, 'recipients')" [matAutocomplete]="autoEmails"
                       (focus)="resetAutocomplete()" (paste)="onPaste($event,'recipients')"
                       [readonly]="recipientDisabled" [attr.disabled]="recipientDisabled">
            </mat-chip-list>
            <mat-autocomplete #autoEmails="matAutocomplete"
                              (optionSelected)="addEmail($event.option.value, 'recipients')">
                @for (option of filteredEmails | async; track option) {
                    <mat-option [value]="option">
                        {{ option.label }}@if (option.type !== 'contactGroup') {
                        <span class="mailLabel">
            ({{ option.email }})</span>
                    }
                    </mat-option>
                }
            </mat-autocomplete>
            <mat-hint [innerText]="'lang.separatorsEmail' | translate"></mat-hint>
        </mat-form-field>
    }
    <!-- EDISYUM - NCH01 Ajout d'un accusé de lecture -->
    @if (!readonly) {
        <mat-checkbox class="primary" [(ngModel)]="receivedReceipt"
                      [disabled]="mailSecureConf['pastell']['byDefault']['value']">
            <!-- EDISSYUM - ASY01 Implémentation envoie de Mail sécurisé via Pastell-->
            {{ 'lang.ask_read_receipt' | translate }}
        </mat-checkbox>
    }
    <!-- END EDISSYUM - NCH01 -->
    @if (showCopies) {
        <mat-form-field>
            <span matPrefix class="mailLabel">{{ 'lang.copieShort' | translate }}&nbsp;:&nbsp;</span>
            <mat-chip-list id="copies-list" #copiesList cdkDropList
                           [cdkDropListConnectedTo]="['recipients-list','invcopies-list']" [cdkDropListData]="copies"
                           (cdkDropListDropped)="drop($event)">
                @for (copy of copies; track copy) {
                    <mat-chip cdkDrag [cdkDragDisabled]="cCDisabled" class="copy"
                              [removable]="!cCDisabled" (removed)="!cCDisabled ? remove(copy, 'copies') : false"
                              (click)="!cCDisabled ? remove(copy, 'copies') : false" [title]="copy.email"
                              [class.badFormat]="copy.badFormat">
                        {{ copy.label }}{{ copy.label !== copy.email ? ' (' + copy.email + ')' : '' }}
                        @if (!cCDisabled) {
                            <mat-icon matChipRemove class="fa fa-times"></mat-icon>
                        }
                    </mat-chip>
                }
                <input [formControl]="recipientsInput" #copiesField [matChipInputFor]="copiesList"
                       [matChipInputSeparatorKeyCodes]="separatorKeysCodes" [matChipInputAddOnBlur]="true"
                       (matChipInputTokenEnd)="add($event, 'copies')" [matAutocomplete]="autoEmails2"
                       (focus)="resetAutocomplete()" (paste)="onPaste($event,'copies')" [disabled]="readonly">
            </mat-chip-list>
            <mat-autocomplete #autoEmails2="matAutocomplete" (optionSelected)="addEmail($event.option.value, 'copies')">
                @for (option of filteredEmails | async; track option) {
                    <mat-option [value]="option">
                        {{ option.label }}@if (option.type !== 'contactGroup') {
                        <span class="mailLabel">
          ({{ option.email }})</span>
                    }
                    </mat-option>
                }
            </mat-autocomplete>
        </mat-form-field>
    }
    @if (showInvisibleCopies) {
        <mat-form-field>
            <span matPrefix class="mailLabel">{{ 'lang.invisibleCopyShort' | translate }}&nbsp;:&nbsp;</span>
            <mat-chip-list id="invcopies-list" #invCopiesList cdkDropList
                           [cdkDropListConnectedTo]="['recipients-list','copies-list']"
                           [cdkDropListData]="invisibleCopies"
                           (cdkDropListDropped)="drop($event)">
                @for (invCopy of invisibleCopies; track invCopy) {
                    <mat-chip cdkDrag [cdkDragDisabled]="cCIDisabled" class="copy"
                              [removable]="cCIDisabled"
                              (removed)="!cCIDisabled ? remove(invCopy, 'invisibleCopies') : false"
                              (click)="!cCIDisabled ? remove(invCopy, 'invisibleCopies') : false"
                              [title]="invCopy.email"
                              [class.badFormat]="invCopy.badFormat">
                        {{ invCopy.label }}{{ invCopy.label !== invCopy.email ? ' (' + invCopy.email + ')' : '' }}
                        @if (!cCIDisabled) {
                            <mat-icon matChipRemove class="fa fa-times"></mat-icon>
                        }
                    </mat-chip>
                }
                <input [formControl]="recipientsInput" #invisibleCopiesField [matChipInputFor]="invCopiesList"
                       [matChipInputSeparatorKeyCodes]="separatorKeysCodes" [matChipInputAddOnBlur]="true"
                       (matChipInputTokenEnd)="add($event, 'invisibleCopies')" [matAutocomplete]="autoEmails3"
                       (focus)="resetAutocomplete()" (paste)="onPaste($event,'invisibleCopies')" [disabled]="readonly">
            </mat-chip-list>
            <mat-autocomplete #autoEmails3="matAutocomplete"
                              (optionSelected)="addEmail($event.option.value, 'invisibleCopies')">
                @for (option of filteredEmails | async; track option) {
                    <mat-option [value]="option">
                        {{ option.label }}@if (option.type !== 'contactGroup') {
                        <span class="mailLabel">
          ({{ option.email }})</span>
                    }
                    </mat-option>
                }
            </mat-autocomplete>
        </mat-form-field>
    }
    @if (!subjectHide) {
        <mat-form-field floatLabel="never">
    <span matPrefix><span
            class="mailLabel">{{ 'lang.object' | translate }}&nbsp;:&nbsp;</span>@if (subjectPrefix !== null) {
        <span class="subjectPrefix">{{ subjectPrefix }}</span>
    }&nbsp;</span>
            <input matInput [disabled]="readonly" [(ngModel)]="emailSubject"
                   maxlength="255">
            @for (keyVal of emailAttachTool | keyvalue; track keyVal) {
                <button mat-icon-button matSuffix
                        [disabled]="readonly ||(keyVal.key !== 'summarySheet' && (emailAttachTool[keyVal.key].list.length === 0) || (keyVal.key === 'summarySheet' && !functions.empty(emailAttach['summarySheet'])))"
                        [title]="emailAttachTool[keyVal.key].title"
                        (click)="$event.stopPropagation();currentEmailAttachTool=keyVal.key;openSummarySheetModal(keyVal.key)"
                        [matMenuTriggerFor]="emailAttachListMenu">
                    <mat-icon class="{{emailAttachTool[keyVal.key].icon}}"
                              [class.activeButton]="(keyVal.key === 'document' && emailAttach.document?.isLinked) || (keyVal.key !== 'document' && emailAttach[keyVal.key] && emailAttach[keyVal.key].length > 0)"
                              class="primary"></mat-icon>
                </button>
            }
            <mat-menu #emailAttachListMenu="matMenu" [class]="'attachListMenu'">
                @for (keyVal of emailAttachTool | keyvalue; track keyVal) {
                    @if (keyVal.key === currentEmailAttachTool) {
                        @for (attach of emailAttachTool[keyVal.key].list; track attach) {
                            <button mat-menu-item class="attachListButton"
                                    style="line-height: normal;height: auto;padding: 10px;" disableRipple
                                    [disabled]="isSelectedAttachMail(attach,keyVal.key)"
                                    (click)="$event.stopPropagation();">
                                <div class="attachListContainer">
                                    <div>
                                        @if (attach.status !== 'SIGN' && !attach.isSigned) {
                                            <button mat-raised-button class="extensionButton primary"
                                                    (click)="toggleAttachMail(attach,keyVal.key,'original');">
                                                .{{ attach.format }}
                                            </button>
                                            <br/>
                                        }
                                        @if ((!functions.empty(attach.convertedDocument) && attach.format !== 'pdf') || attach.status === 'SIGN' || attach.isSigned) {
                                            <button mat-raised-button class="extensionButton primary" (click)="toggleAttachMail(attach, keyVal.key,'pdf');">
                                                .pdf
                                            </button>
                                            <br/>
                                        }
                                    </div>
                                    <div>
                <span [title]="attach.label">
                  <div style="font-size: 10px;opacity: 0.5;">
                    @if (!functions.empty(attach.chrono)) {
                        {{ attach.chrono }} &nbsp;
                    }
                      {{ attach.creator }}
                  </div>
                  <div>
                    {{ attach.label | shorten: 45: '...' }}
                  </div>
                  <div class="mailLabel" style="font-size: 10px;">
                    {{ attach.typeLabel }}@if (attach.status === 'SIGN') {
                      <span
                              style="color:green">&nbsp;({{ 'lang.signed' | translate | lowercase }})</span>
                  }
                </div>
                    @if (attach.recipientId !== null && keyVal.key === 'attachments') {
                        <div class="recipientPj">
                    @if (attach.recipientLabel !== null) {
                        <div style="margin-top: 5px;">
                        {{ (attach.onlyCompany && attach.recipientType === 'contact' ? 'lang.company' : 'lang.recipient') | translate }}
                            : <b [title]="attach.recipientLabel">{{ attach.recipientLabel }}</b>
                      </div>
                    }
                  </div>
                    }
                    @if (attach.recipientId === null && keyVal.key === 'attachments') {
                        <div style="font-size: 10px; color: gray; font-style: italic; margin-top: 5px;">
                    {{ 'lang.noRecipient' | translate }}
                  </div>
                    }
              </span>
                                    </div>
                                </div>
                            </button>
                            <mat-divider></mat-divider>
                        }
                    }
                }
            </mat-menu>
        </mat-form-field>
    }
    @if (!loading) {
        <mat-chip-list>
            @if (emailAttach.document?.isLinked) {
                <mat-chip class="copy"
                          [removable]="!readonly" (removed)="removeAttachMail(0, 'document')"
                          [title]="emailAttach.document.chrono + ' - ' + emailAttach.document.label"
                          (click)="openDocument('resources', emailAttach.document)">
                    <i
                            class="fa fa-file mailLabel"></i>&nbsp;{{ emailAttach.document.label | shorten: 25: '...' }}&nbsp;<small
                        class="mailLabel">({{ emailAttach.document.format }} - {{ emailAttach.document.size }})</small>
                    @if (!readonly) {
                        <mat-icon matChipRemove class="fa fa-times"></mat-icon>
                    }
                </mat-chip>
            }
            @for (keyVal of emailAttach | keyvalue; track keyVal) {
                @if (keyVal.key !== 'document') {
                    @for (item of emailAttach[keyVal.key]; track item; let i = $index) {
                        <mat-chip class="copy"
                                  [removable]="!readonly"
                                  (removed)="removeAttachMail(i, keyVal.key)" [title]="item.label"
                                  (click)="openDocument(keyVal.key, item)">
                            <i
                                    class="{{emailAttachTool[keyVal.key].icon}} mailLabel"></i>&nbsp;{{ item.label | shorten: 25: '...' }}&nbsp;<small
                                class="mailLabel">({{ item.format }}{{ !functions.empty(item.size) ? ' - ' + item.size : '' }}
                            )</small>
                            @if (!readonly) {
                                <mat-icon matChipRemove class="fa fa-times"></mat-icon>
                            }
                        </mat-chip>
                    }
                }
            }
        </mat-chip-list>
    }

    <!-- EDISSYUM - AMO01 Rajout d'une option pour envoyer les PJ via liens épémères -->
    @if (nextcloudFieldsFilled && (emailAttach['attachments'] && emailAttach['attachments'].length > 0) || (emailAttach.document && emailAttach.document['isLinked']) || (emailAttach['notes'] && emailAttach['notes'].length > 0) || (emailAttach['summarySheet'] && emailAttach['summarySheet'].length > 0)) {
        <div> <!-- Si au moins une pj est présente, afficher checkbox-->
            @if (nextcloudFieldsFilled && attachmentsHostsConf['nextcloud']['byDefault']['value']) {
                <mat-checkbox id="checkbox_attachment_host"
                              [ngModel]="attachmentsHostsConf['nextcloud']['byDefault']['value'] || sentWithNextcloud"
                              (ngModelChange)="attachmentsHostsConf['nextcloud']['byDefault']['value'] || (sentWithNextcloud = $event)"
                              [disabled]="readonly || hasError" [title]="'lang.checkboxAttachementsTitle' | translate"
                              [formControl]="checkBoxAttachments" (change)="changeCheckBoxValueAttachments($event)"
                              class="primary">
                    <span>&nbsp;{{ 'lang.checkboxPlaceholder' | translate }}</span>
                </mat-checkbox>
            }
        </div>
    }
    <!-- END EDISSYUM - AMO01 -->

    <!-- EDISSYUM - ASY01 - Implémentation envoie de Mail sécurisé via pastell -->
    @if (mailSecureConf['pastell']['enabled']['value']) {
        <div>
            <mat-checkbox id="checkbox_mailsec" [(ngModel)]="mailSecureConf['pastell']['byDefault']['value']"
                          [disabled]="readonly || msHasError"
                          [formControl]="mailSecureConf['pastell']['byDefault']" (change)="changeAccuseLecture()"
                          class="primary">
                <span>&nbsp;{{ 'lang.checkboxMailSec' | translate }}</span>
            </mat-checkbox>
        </div>
    }
    <!-- END EDISSYUM - ASY01 -->

    @if (!readonly && !bodyHide) {
        <div class="models">
            @if (availableEmailModels.length > 0) {
                <app-plugin-select-search [label]="'lang.emailModel' | translate"
                                          [placeholderLabel]="'lang.emailModel' | translate"
                                          [datas]="availableEmailModels" [class]="''" appearance="fill"
                                          [formControlSelect]="templateEmailListForm"
                                          (afterSelected)="mergeEmailTemplate($event)">
                </app-plugin-select-search>
            }
            @if (availableSignEmailModels.length > 0) {
                <app-plugin-select-search #templateList
                                          [label]="'lang.emailSignatures' | translate"
                                          [placeholderLabel]="'lang.emailSignatures' | translate" [class]="''"
                                          appearance="fill"
                                          [datas]="availableSignEmailModels" [formControlSelect]="emailSignListForm"
                                          returnValue="object"
                                          (afterSelected)="mergeSignEmailTemplate($event)">
                </app-plugin-select-search>
            }
        </div>
    }
    @if (!bodyHide) {
        <textarea style="padding-top: 10px;visibility: hidden;" name="emailSignature" id="emailSignature"
                  [(ngModel)]="emailContent"></textarea>
    }
</div>
