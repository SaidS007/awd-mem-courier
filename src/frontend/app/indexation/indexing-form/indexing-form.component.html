@if (loading) {
  <div style="display:flex;height:100%;">
    <mat-spinner style="margin:auto;"></mat-spinner>
  </div>
}
@if (!loading) {
  @if (!adminMode && mode === 'indexation') {
    <div
      style="display: flex;align-items: center;justify-content: flex-end;margin-top: 10px;margin-bottom: -20px;">
      <button mat-button class="categoryLabel" (click)="toggleMailTracking()"
        [title]="arrFormControl['mail­tracking'].value ? ('lang.untrackThisMail' | translate) : ('lang.trackThisMail' | translate)">
        {{arrFormControl['mail­tracking'].value ? ('lang.untrackThisMail' | translate) : ('lang.trackThisMail' | translate)}}
        <mat-icon class="{{this.arrFormControl['mail­tracking'].value ? 'fas':'far'}} fa-star"
        style="font-size: 20px; color: #3A7C00"></mat-icon>
      </button>
    </div>
  }
  @for (category of fieldCategories; track category) {
    @if (this['indexingModels_'+category].length > 0 || adminMode) {
      <div class="banner"
        [style.borderColor]="currentPriorityColor">
        <div class="title" [style.color]="currentPriorityColor">
          {{'lang.' + category| translate | uppercase }} @if (category === 'mail') {
          <small
          [title]="'lang.category_id' | translate">{{'lang.indexing_' + currentCategory | translate | titlecase}}</small>
        }
        <div class="title-divider"></div>
      </div>
      <div class="content">
        <div cdkDropList id="indexingModelsCustomFieldsList_{{category}}"
          [cdkDropListConnectedTo]="['indexingModelsCustomFieldsList_mail','indexingModelsCustomFieldsList_contact','indexingModelsCustomFieldsList_process','indexingModelsCustomFieldsList_classifying','customFieldsList','fieldsList']"
          [cdkDropListData]="this['indexingModels_'+category]" [cdkDropListDisabled]="!adminMode"
          (cdkDropListDropped)="drop($event)" class="indexingModelsCustomFieldsList"
          style="min-height: 50px;">
          @for (field of this['indexingModels_'+category]; track field; let i = $index) {
            @if (field.unit === category) {
              <div class="fieldRow" cdkDrag cdkDragLockAxis="y"
                [cdkDragData]="field">
                @if ((!adminMode && !appService.getViewMode()) || adminMode) {
                  <div class="fieldLabel">
                    @if (adminMode) {
                      <i [title]="'lang.move' | translate"
                        class="fas fa-bars fa-2x" style="cursor: move; color: #3A7C00"
                      cdkDragHandle></i>
                      }&nbsp;
                      {{field.label}}
                      @if (adminMode) {
                        <button mat-icon-button [matMenuTriggerFor]="fieldActions">
                          <mat-icon class="fa fa-ellipsis-v" style="color:#C25712"></mat-icon>
                        </button>
                      }
                      <mat-menu #fieldActions="matMenu" [class]="'parametersFieldsMenu'">
                        @if (!field.system) {
                          <button mat-menu-item (click)="field.mandatory = !field.mandatory"
                            >
                            @if (!field.mandatory) {
                              <span>{{'lang.mandatoryField' | translate}}</span>
                            }
                            @if (field.mandatory) {
                              <span>{{'lang.optionalField' | translate}}</span>
                            }
                          </button>
                        }
                        @if (!field.system) {
                          <mat-divider></mat-divider>
                        }
                        @if (!field.enabled) {
                          <button mat-menu-item (click)="enableField(field, true)">
                            <span>{{'lang.enableField' | translate}}</span>
                          </button>
                        }
                        @if (field.enabled) {
                          <button mat-menu-item (click)="enableField(field, false)">
                            <span>{{'lang.disableField' | translate}}</span>
                          </button>
                        }
                        @if (!field.SQLMode && field.identifier === 'doctype') {
                          <button mat-menu-item (click)="openValuesSelector(field)">
                            <span>{{'lang.chooseValues' | translate}}</span>
                          </button>
                        }
                        @if (!field.system) {
                          <mat-divider></mat-divider>
                        }
                        @if (!field.system && field.identifier.indexOf('registeredMail_') === -1 && ((currentCategory === 'registeredMail' && field.identifier !== 'departureDate') ||
                          currentCategory !== 'registeredMail')) {
                          <button mat-menu-item (click)="removeItem('indexingModels_'+category,field,i)"
                            >
                            <mat-icon class="fa fa-trash" style="color:#8e3e52"></mat-icon>
                            <span>{{'lang.delete' | translate}}</span>
                          </button>
                        }
                      </mat-menu>
                    </div>
                  }
                  <div class="fieldInput" [class.textareaInput]="field.type === 'string'"
                    [class.checkboxInput]="field.type === 'checkbox'">
                    @if (field.type === 'string') {
                      @if (field.SQLMode && adminMode) {
                        <button mat-button class="primary" matPrefix
                          mat-icon-button disabled style="position: absolute;left: -40px;"
                          [title]="'lang.bddModeCustomFieldMsg' | translate">
                          <mat-icon style="color: #3A7C00" class="fas fa-database">
                          </mat-icon>
                        </button>
                      }
                      <mat-form-field class="input-form"
                        [floatLabel]="appService.getViewMode() ? '' : 'never'">
                        @if (appService.getViewMode()) {
                          <mat-label>{{field.label}}</mat-label>
                        }
                        <textarea [id]="field.identifier" matInput cdkTextareaAutosize
                          [formControl]="arrFormControl[field.identifier]"
                          [placeholder]="!adminMode ? ('lang.typeValue' | translate) : ('lang.defaultValue' | translate)"
                        class="subject"></textarea>
                      </mat-form-field>
                    }
                    @if (field.type === 'integer') {
                      @if (field.SQLMode && adminMode) {
                        <button mat-button class="primary" matPrefix
                          mat-icon-button disabled style="position: absolute;left: -40px;"
                          [title]="'lang.bddModeCustomFieldMsg' | translate">
                          <mat-icon style="color: #3A7C00" class="fas fa-database">
                          </mat-icon>
                        </button>
                      }
                      <mat-form-field class="input-form"
                        [floatLabel]="appService.getViewMode() ? '' : 'never'">
                        @if (appService.getViewMode()) {
                          <mat-label>{{field.label}}</mat-label>
                        }
                        <input [id]="field.identifier" type="number" matInput
                          [formControl]="arrFormControl[field.identifier]"
                          [placeholder]="!adminMode ? ('lang.typeValue' | translate) : ('lang.defaultValue' | translate)"
                          min="0" step="0.1">
                      </mat-form-field>
                    }
                    @if (field.type === 'select') {
                      @if (field.SQLMode && adminMode) {
                        <button mat-button class="primary" matPrefix
                          mat-icon-button disabled style="position: absolute;left: -40px;"
                          [title]="'lang.bddModeCustomFieldMsg' | translate">
                          <mat-icon style="color: #3A7C00" class="fas fa-database">
                          </mat-icon>
                        </button>
                      }
                      <app-plugin-select-search [id]="field.identifier"
                        [showResetOption]="adminMode || !field.mandatory" [label]="field.label"
                        [placeholderLabel]="!adminMode ? ('lang.chooseValue' | translate) : ('lang.defaultValue' | translate)"
                        [formControlSelect]="arrFormControl[field.identifier]" [datas]="field.values"
                        (afterSelected)="launchEvent($event, field)" style="width:100%;">
                      </app-plugin-select-search>
                    }
                    @if (field.type === 'date') {
                      @if (field.SQLMode && adminMode) {
                        <button mat-button class="primary" matPrefix
                          mat-icon-button disabled style="position: absolute;left: -40px;"
                          [title]="'lang.bddModeCustomFieldMsg' | translate">
                          <mat-icon style="color: #3A7C00" class="fas fa-database">
                          </mat-icon>
                        </button>
                      }
                      @if (adminMode && !field.SQLMode && field.identifier !== 'processLimitDate' && (!arrFormControl[field.identifier].disabled || field.today)) {
                        <button mat-button class="primary" matPrefix
                          mat-icon-button (click)="$event.stopPropagation();toggleTodayDate(field);"
                          [matTooltip]="'lang.todayDate' | translate"
                          style="position: absolute;left: -40px;">
                          <mat-icon style="color: #3A7C00"
                            class="{{field.today ? 'far fa-bell-slash' : 'far fa-bell'}}">
                          </mat-icon>
                        </button>
                      }
                      @if (adminMode && !field.SQLMode && field.identifier === 'processLimitDate') {
                        <button matPrefix mat-icon-button
                          style="position: absolute;left: -40px; cursor: help; color: #3A7C00"
                          [matTooltip]="'lang.processLimitDatetoggleDisableDesc' | translate">
                          <mat-icon class="fas fa-circle-info"></mat-icon>
                        </button>
                      }
                      <mat-form-field class="input-form input-date"
                        [floatLabel]="appService.getViewMode() ? '' : 'never'" (click)="picker.open()"
                        style="cursor:pointer;">
                        @if (appService.getViewMode()) {
                          <mat-label>{{field.label}}</mat-label>
                        }
                        <input [id]="field.identifier" [formControl]="arrFormControl[field.identifier]"
                          matInput [matDatepicker]="picker"
                          [placeholder]="!adminMode ? ('lang.chooseDate' | translate) : ('lang.defaultValue' | translate)"
                          [min]="getMinDate(field.startDate)" [max]="getMaxDate(field.endDate)"
                          readonly style="cursor:pointer;" (dateChange)="launchEvent($event, field)">
                        @if (!arrFormControl[field.identifier].value) {
                          <mat-datepicker-toggle matSuffix [for]="picker"
                            >
                          </mat-datepicker-toggle>
                        }
                        <mat-datepicker [touchUi]="appService.getViewMode()" #picker></mat-datepicker>
                        @if (arrFormControl[field.identifier].value && !arrFormControl[field.identifier].disabled) {
                          <button mat-button class="warn" matSuffix mat-icon-button
                            (click)="$event.stopPropagation();arrFormControl[field.identifier].reset();"
                            [title]="'lang.eraseValue' | translate">
                            <mat-icon style="color:#8e3e52" class="fa fa-calendar-times">
                            </mat-icon>
                          </button>
                        }
                      </mat-form-field>
                    }
                    @if (field.type === 'radio') {
                      @if (field.SQLMode && adminMode) {
                        <button mat-button class="primary" matPrefix
                          mat-icon-button disabled style="position: absolute;left: -40px;"
                          [title]="'lang.bddModeCustomFieldMsg' | translate">
                          <mat-icon style="color: #3A7C00" class="fas fa-database">
                          </mat-icon>
                        </button>
                      }
                      <mat-form-field class="input-form input-radio"
                        [floatLabel]="appService.getViewMode() ? '' : 'never'">
                        @if (appService.getViewMode()) {
                          <mat-label>{{field.label}}</mat-label>
                        }
                        <input matInput style="display: none;">
                        <mat-radio-group class="radio-form primary"
                          [formControl]="arrFormControl[field.identifier]">
                          @for (value of field.values; track value) {
                            <mat-radio-button [value]="value.id"
                              [disabled]="value.disabled">
                              {{value.label}}
                            </mat-radio-button>
                          }
                        </mat-radio-group>
                      </mat-form-field>
                    }
                    @if (field.type === 'checkbox') {
                      @if (field.SQLMode && adminMode) {
                        <button mat-button class="primary" matPrefix
                          mat-icon-button disabled style="position: absolute;left: -40px;"
                          [title]="'lang.bddModeCustomFieldMsg' | translate">
                          <mat-icon style="color: #3A7C00" class="fas fa-database">
                          </mat-icon>
                        </button>
                      }
                      <div class="input-form checkbox-form">
                        <mat-selection-list #shoes class="div-list"
                          [formControl]="arrFormControl[field.identifier]">
                          @for (value of field.values; track value) {
                            <mat-list-option class="primary"
                              [value]="value.id" checkboxPosition="before">
                              {{value.label}}
                            </mat-list-option>
                          }
                        </mat-selection-list>
                      </div>
                      <mat-chip-list class="checkbox-selected-list"
                        [disabled]="field.system && adminMode">
                        @for (chip of shoes.selectedOptions.selected; track chip) {
                          <mat-chip selected>
                            {{getCheckboxListLabel(chip.value, field.values)}}
                          </mat-chip>
                        }
                      </mat-chip-list>
                    }
                    <!--<ng-container *ngIf="field.type === 'autocomplete'">
                    <app-plugin-autocomplete [labelPlaceholder]="'lang.searchValue' | translate"
                      [routeDatas]="[field.values[0]]" [targetSearchKey]="'idToDisplay'"
                      [size]="'small'" [control]="arrFormControl[field.identifier]"
                      [manageDatas]="!adminMode ? field.values[1] : undefined" style="width:100%;">
                    </app-plugin-autocomplete>
                  </ng-container>-->
                  @if (['senders','recipients'].indexOf(field.identifier) > -1) {
                    <app-contact-autocomplete #appContactAutocomplete [id]="field.identifier"
                      [controlAutocomplete]="arrFormControl[field.identifier]" style="width:100%;"
                      (retrieveDocumentEvent)="retrieveDocumentEvent.emit()"
                      (afterContactSelected)="selectedContact($event, field.identifier)" (removeContactEvent)="checkRemovedItem($event)">
                    </app-contact-autocomplete>
                  }
                  @if (field.identifier === 'folders') {
                    <app-folder-input [control]="arrFormControl[field.identifier]" style="width:100%;">
                    </app-folder-input>
                  }
                  @if (field.identifier === 'tags') {
                    <app-tag-input [control]="arrFormControl[field.identifier]" style="width:100%;">
                    </app-tag-input>
                  }
                  @if (field.type === 'banAutocomplete') {
                    <app-address-ban-input [controlAutocomplete]="arrFormControl[field.identifier]"
                      [adminMode]="adminMode" style="width:100%;">
                    </app-address-ban-input>
                  }
                  @if (field.type === 'contact') {
                    <app-contact-autocomplete [id]="field.identifier"
                      [controlAutocomplete]="arrFormControl[field.identifier]" style="width:100%;"
                      (retrieveDocumentEvent)="retrieveDocumentEvent.emit()">
                    </app-contact-autocomplete>
                  }
                  @if (field.identifier === 'registeredMail_issuingSite') {
                    <app-issuing-site-input #appIssuingSiteInput
                      [registedMailType]="arrFormControl['registeredMail_type'].value"
                      [control]="arrFormControl[field.identifier]"
                      [showResetOption]="adminMode || !field.mandatory"
                      (afterSelected)="launchEvent($event, field)" style="width:100%;">
                    </app-issuing-site-input>
                  }
                  @if (field.identifier === 'registeredMail_recipient') {
                    @if (mode === 'indexation') {
                      <app-contact-autocomplete
                        [exclusion]="'?noUsers=true&noEntities=true&noContactsGroups=true'"
                        [id]="field.identifier" [singleMode]="true"
                        [controlAutocomplete]="arrFormControl[field.identifier]" style="width:100%;"
                        (retrieveDocumentEvent)="retrieveDocumentEvent.emit()">
                      </app-contact-autocomplete>
                    }
                    @if (mode !== 'indexation') {
                      <app-registered-mail-recipient-input
                        #appRegisteredMailRecipientInput [control]="arrFormControl[field.identifier]"
                        [registeredMailType]="arrFormControl['registeredMail_type'].value"
                        style="width:100%;">
                      </app-registered-mail-recipient-input>
                    }
                  }
                </div>
                <div class="fieldState">
                  @if (adminMode || (arrFormControl[field.identifier].hasError('required') && arrFormControl[field.identifier].untouched)) {
                    <i class="fas fa-asterisk fieldRequired"
                    [class.noMandatory]="!field.mandatory"></i>
                  }
                  @if (!adminMode && arrFormControl[field.identifier].touched && arrFormControl[field.identifier].hasError('required')) {
                    <i class="fas fa-exclamation-triangle fieldError"
                    ></i>
                  }
                  @if (!adminMode && arrFormControl[field.identifier].valid && !isEmptyField(field)) {
                    <i class="fas fa-check fieldFull"
                    ></i>
                  }
                </div>
              </div>
            }
            @if (hasLinkedRes && field.identifier === 'senders') {
              <div class="linkRes">
                {{msgToDisplay}}
                <ng-container>
                  <button style="cursor: pointer; display: contents; font-weight: bold; font-size: 14px;" (click)="openSearchResourceModal()">{{'lang.seeMore' | translate}}</button>
                </ng-container>
              </div>
            }
            @if (field.identifier === 'destination' && !adminMode && arrFormControl['destination'].value > 0 && !hideDiffusionList) {
              <div
                >
                <mat-divider></mat-divider>
                            <div style="padding: 10px;font-size: 16px;color: #3A7C00;letter-spacing: 2px;font-weight: bold;display: flex;
                                align-items: center;">
                  <div style="display: flex;flex: 1;align-items: center;">
                    {{'lang.diffusionList' | translate}} @if (appDiffusionsList.canUpdateRoles() && canEdit && mode !== 'process' && field.enabled) {
                    <button mat-icon-button
                      style="color: #3A7C00" (click)="appDiffusionsList.switchMode()"
                      [title]="'lang.modifyDiffusionList' | translate">
                      <mat-icon class="fa fa-edit"></mat-icon>
                    </button>
                  }
                </div>
                <div class="fieldState" style="width: 20px;padding: 0px;">
                  @if (adminMode || (arrFormControl['diffusionList'].hasError('required') && arrFormControl['diffusionList'].untouched)) {
                    <i class="fas fa-asterisk fieldRequired"
                    [class.noMandatory]="!field.mandatory"></i>
                  }
                  @if (!adminMode && arrFormControl['diffusionList'].touched && arrFormControl['diffusionList'].status === 'INVALID') {
                    <i class="fas fa-exclamation-triangle fieldError"
                    ></i>
                  }
                  @if (!adminMode && arrFormControl['diffusionList'].valid && !isEmptyField(field)) {
                    <i class="fas fa-check fieldFull"
                    ></i>
                  }
                </div>
              </div>
              <app-diffusions-list #appDiffusionsList [resId]="resId"
                [entityId]="arrFormControl[field.identifier].value"
                [diffFormControl]="arrFormControl['diffusionList']"
                [noDiffusionRole]="this.indexingModelClone.noDiffusionRole"
                [allowedEntities]="field.allowedEntities" [category]="currentCategory"
                [target]="'indexation'" [selfDest]="selfDest" [customDiffusion]="customDiffusion" (triggerEvent)="changeDestination($event,field.allowedEntities)"> <!-- EDISSYUM - NCH01 Ajout d'un paramètre pour ne pas remonter les rôles de diffusion dans l'indexation -->
              </app-diffusions-list>
              <mat-divider></mat-divider>
            </div>
          }
        }
      </div>
    </div>
  </div>
}
}
}
