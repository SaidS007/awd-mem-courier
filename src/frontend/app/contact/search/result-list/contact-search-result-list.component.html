<mat-card id="viewThumbnail" style="display:none;position: fixed;z-index: 2;margin-left: -28px; top: 0;">
  @if (thumbnailUrl !== '') {
    <img style="max-height: 100vh;" [src]="thumbnailUrl | secureUrl | async" />
  }
</mat-card>
<ng-template #filterTemplate>
  @if (!hideFilter) {
    <app-contact-filter-tool-search #appFilterToolContactSearch [filters]="dataFilters" [isLoadingResults]="isLoadingResults" (filterChanged)="launchSearch()"
    ></app-contact-filter-tool-search>
  }
</ng-template>
<ng-template #toolTemplate>
  <div class="filtersContent">
    <div style="flex: 1"></div>
    <div class="orderTool">
      <mat-form-field class="basket-order">
        <mat-icon matPrefix class="fa fa-list"></mat-icon>
        <mat-select [(ngModel)]="this.listProperties.order" (selectionChange)="updateFilters()"
          [disabled]="isLoadingResults || data.length === 0">
          @for (column of displayColsOrder; track column) {
            <mat-option [value]="column.id">
              {{'lang.' + column.id | translate}}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    <div class="ascDescTool">
      <button [disabled]="this.listProperties.order == '' || isLoadingResults ||Â data.length === 0"
        [style.opacity]="this.listProperties.order == '' ? '0.2' : '1'" mat-fab
        [title]="this.listProperties.orderDir == 'DESC' ? ('lang.descOrder' | translate) : ('lang.ascOrder' | translate)"
        style="color: rgba(0,0,0,0.38);" (click)="changeOrderDir();">
        @if (this.listProperties.orderDir == 'DESC') {
          <mat-icon fontSet="fas"
            fontIcon="fa-sort-amount-down fa-2x">
          </mat-icon>
        }
        @if (this.listProperties.orderDir == 'ASC') {
          <mat-icon fontSet="fas"
            fontIcon="fa-sort-amount-up fa-2x">
          </mat-icon>
        }
      </button>
    </div>
  </div>
  <div class="filterBadges">
    @if (!emptyCriteria()) {
      <span class="label badge-eraser" (click)="removeCriteria('_ALL')"
        title="{{'lang.eraseAllFilters' | translate}}"><i class="fas fa-eraser"></i></span>
      }
      @for (critKey of criteria | keyvalue; track critKey) {
        @if (isArrayType(critKey.value.values) && critKey.value.values.length <= 3) {
          @for (val of critKey.value.values; track val) {
            <span class="label badge-search"
              [title]="contactCriteriaTool.getLabelValue(critKey.key,val)"
              (click)="removeCriteria(critKey.key, val)"><i
              class="fa {{getField(critKey.key).icon}}"
            [title]="getField(critKey.key).label"></i>&nbsp;{{contactCriteriaTool.getLabelValue(critKey.key,val)}}&nbsp;<i
          class="fa fa-times-circle"></i></span>
        }
      }
      @if (isArrayType(critKey.value.values) && critKey.value.values.length > 3) {
        <span class="label badge-search"
          [title]="contactCriteriaTool.getLabelValues(critKey.key,critKey.value.values)"
          (click)="removeCriteria(critKey.key)"><i
          class="fa {{getField(critKey.key).icon}}"
        [title]="getField(critKey.key).label"></i>&nbsp;{{critKey.value.values.length}}
        valeurs&nbsp;<i class="fa fa-times-circle"></i></span>
      }
      @if (!isArrayType(critKey.value.values) && critKey.key !== 'meta') {
        <span class="label badge-search"
          [title]="contactCriteriaTool.getFormatLabel(critKey.key,critKey.value.values)"
          (click)="removeCriteria(critKey.key)"><i
          class="fa {{getField(critKey.key).icon}}"
        [title]="getField(critKey.key).label"></i>&nbsp;{{contactCriteriaTool.getFormatLabel(critKey.key,critKey.value.values)}}&nbsp;<i
      class="fa fa-times-circle"></i></span>
    }
    @if (!isArrayType(critKey.value.values) && critKey.key === 'meta') {
      <span class="label badge-search" [title]="'meta'"
        (click)="removeCriteria(critKey.key)">{{critKey.value.values}}&nbsp;<i
      class="fa fa-times-circle"></i></span>
    }
  }
</div>
</ng-template>
@if (isLoadingResults) {
  <div class="example-loading-shade">
    @if (isLoadingResults) {
      <mat-spinner></mat-spinner>
    }
  </div>
}
<div class="table-head">
  <div class="table-head-result">
    @if (!singleSelection) {
      <mat-checkbox class="primary"
        [checked]="selectedContacts.length == resultsLength && selectedContacts.length > 0"
        [indeterminate]="selectedContacts.length > 0 && selectedContacts.length < resultsLength"
        style="margin: 10px;padding-right: 10px;" title="{{'lang.selectAllResInBasket' | translate}}"
        (change)="toggleAllRes($event)">
      </mat-checkbox>
      }&nbsp;{{resultsLength}}
      {{'lang.records' | translate | ucfirst}}&nbsp;@if (selectedContacts.length > 0) {
      <small>-
        {{selectedContacts.length}}
      {{'lang.selected' | translate}}</small>
    }
  </div>
  <div class="table-head-tool">
    <span style="position: relative;">
      <mat-paginator #paginatorResultList [length]="paginatorLength" [pageSizeOptions]="[10, 25, 50, 100, 150]"
      class="paginatorResultList"></mat-paginator>
      <app-select-page [paginator]="paginatorResultList"></app-select-page>
    </span>
    @if (actionMode) {
      <span>
        <button mat-stroked-button [matMenuTriggerFor]="menu">{{'lang.actionsAlt' | translate}}
          <mat-icon matSuffix class="fa fa-caret-down"></mat-icon>
        </button>
        <span [matMenuTriggerFor]="menu" #menu2 style="position: fixed;"></span>
        <mat-menu #menu="matMenu" [class]="'actionListMenu'">
          @if (this.selectedContacts.length >= 1) {
            <div
              style="text-align: center;font-size: 10px;color: white;background: #3A7C00;padding: 5px;font-weight: bold;">
              {{this.selectedContacts.length}} {{'lang.selectedContacts' | translate}}
            </div>
          }
          <button mat-menu-item [disabled]="selectedContacts.length === 0" (click)="openContactsGroupModal()">{{'lang.newCorrespondentsGroup' | translate}}</button>
          <button mat-menu-item [disabled]="selectedContacts.length === 0" [matMenuTriggerFor]="correspondentsGroupMenu" (menuOpened)="getCorrespondentsGroups()">{{'lang.associateToCorrespondentsGroup' | translate}}</button>
        </mat-menu>
      </span>
    }
    <span>
      <button mat-mini-fab (click)="openContactExport();" [disabled]="selectedContacts.length == 0" title="{{'lang.exportDatas' | translate}}"
        style="color:#3A7C00 !important;"> <!-- EDISSYUM - NCH01 Changement des couleurs de MEM Courrier | Ajout de la balise style -->
        <mat-icon class="fa fa-file-download"></mat-icon>
      </button>
    </span>
    <div style="text-align: center;padding-left:5px;padding-right:5px;">
      <span id="menuButtonContext" [matMenuTriggerFor]="menuContactContext" #contextMenuContact style="position: fixed;"
      [style.left]="contextMenuPosition.x" [style.top]="contextMenuPosition.y"></span>
      <mat-menu #menuContact="matMenu">
        <div style="text-align: center;font-size: 10px;color: white;background: #3A7C00;padding: 5px;font-weight: bold;">
          {{this.selectedContacts.length}} {{'lang.selectedContacts' | translate}}
        </div>
        <button mat-menu-item (click)="openContactsGroupModal()">{{'lang.newCorrespondentsGroup' | translate}}</button>
        <button mat-menu-item [matMenuTriggerFor]="correspondentsGroupMenu" (menuOpened)="getCorrespondentsGroups()">{{'lang.associateToCorrespondentsGroup' | translate}}</button>
      </mat-menu>
      <mat-menu #menuContactContext="matMenu">
        <div
          style="text-align: center;font-size: 10px;color: white;background: #3A7C00;padding: 5px;font-weight: bold;">
          {{this.selectedContacts.length}} {{'lang.selectedContacts' | translate}}
        </div>
        <button mat-menu-item (click)="openContactsGroupModal()">{{'lang.newCorrespondentsGroup' | translate}}</button>
        <button mat-menu-item [matMenuTriggerFor]="correspondentsGroupMenu" (menuOpened)="getCorrespondentsGroups()">{{'lang.associateToCorrespondentsGroup' | translate}}</button>
      </mat-menu>
      <mat-menu #correspondentsGroupMenu="matMenu" [class]="'correspondentsGroupMenuMenu'">
        <div (click)="$event.stopPropagation();"
          style="text-align: center;font-size: 10px;color: white;background: #3A7C00;padding: 5px;font-weight: bold;position: sticky;top: 0px;z-index: 1;">
          {{'lang.correspondentsGroups' | translate}}
        </div>
        <mat-form-field (click)="$event.stopPropagation();" class="smallInput" appearance="outline" floatLabel="never">
          <mat-icon style="color: #3A7C00" class="fa fa-search" matPrefix></mat-icon>
          <input type="text" [formControl]="filterCorrespondentsGroups" [placeholder]="'Filtrer'"
            matInput>
        </mat-form-field>
        @for (group of filteredCorrespondentsGroups | async | sortBy : 'label'; track group) {
          <button mat-menu-item (click)="addContactsToCorrespondentsGroup(group.id)">{{group.label}}
          </button>
        }
        @if (correspondentsGroups.length == 0) {
          <div>
            <span [title]="'lang.noData' | translate" class="noData">{{'lang.noData' | translate}}</span>
          </div>
        }
      </mat-menu>
    </div>
  </div>
</div>
<div [class.integratedContent]="!standalone">
  <table cdkDropList id="document-list" [cdkDropListConnectedTo]="listTodrag()" [cdkDropListData]="data"
    #tableBasketListSort="matSort" mat-table [dataSource]="data" matSort matSortActive="contact_id" matSortDisableClear
    matSortDirection="asc" style="width:100%;" [cdkDropListDisabled]="dragInit || appService.getViewMode()">

    <ng-container matColumnDef="contact_id">
      <td mat-cell *matCellDef="let row" style="padding:0;border-top: solid 1px rgba(0, 0, 0, 0.12);">
        @if (!appService.getViewMode() && row.display.length > 0) {
          <div
            class="sub-info column-{{templateColumns}}-list" style="cursor: initial;">
            @for (data of row.display; track data) {
              <span class="sub-info-data" [class]="data.cssClasses.join(' ')"
                        style="flex:1;white-space: pre;overflow: hidden;text-overflow: ellipsis;
                                padding-left: 5px;
                                padding-right: 5px;"
                [class.hasEvent]="data.event && data.displayValue !== ('lang.undefined' | translate)">
                @if (data.icon != '') {
                  <i class="fa {{data.icon}}" title="{{data.label}}"></i>
                  &nbsp;
                }
                <ng-container>
                  @if (data.value.includes('Date')) {
                    <span [innerHTML]="returnHighlighted(data.value, data.displayValue | timeAgo)"></span>
                  } @else {
                    <span [innerHTML]="data.displayValue"></span>
                  }
                </ng-container>
              </span>
            }
          </div>
        }
        <div class="main-info" [class.selected-data]="row.checked">
          <span style="width:50px;">
            <mat-checkbox class="primary" [checked]="row.checked" (change)="toggleRes($event,row)" [disabled]="singleSelection && !row.hasDocument"
              (click)="$event.stopPropagation();">
            </mat-checkbox>
          </span>
          <span style="cursor:pointer;" [class.highlightResultIcon]="row.inStatus" class="main-info-status"
            (click)="launch(row);">
            @if (row.isPrivate) {
              <span class="watermark" title="Contact confidentiel">
                <i class="fas fa-mask"></i>
              </span>
            }
          </span>
          <span class="main-info-data" (click)="launch(row);" style="font-weight:bold;flex:1;cursor:pointer;margin-left: 50px"
            [class.undefined]="row.subject == ('lang.undefined' | translate)"
            title="{{row.subject_title}}">
            @if (row.lastname && row.firstname) {
              <span
              [innerHTML]="row.lastname + ' ' + row.firstname"></span>
            }
            @if (row.lastname && !row.firstname) {
              <span
              [innerHTML]="row.lastname + ' '"></span>
            }
            @if (!row.lastname && row.firstname) {
              <span
              [innerHTML]="row.firstname + ' '"></span>
            }
            <span [class.extra-min-font]="row.lastname || row.firstname" class="extra" [innerHTML]="row.company"></span>
          </span>

          @if (sidenavRight !== undefined) {
            <span class="main-info-action">
              @if (!appService.getViewMode()) {
                <button mat-icon-button
                  title="{{'lang.linkDetails' | translate}}" [class.highlightResult]="row.inDocument"
                  [routerLink]="'/administration/contacts/list/' + row.contact_id">
                  <mat-icon fontSet="fas" fontIcon="fa-info-circle fa-2x"></mat-icon>
                </button>
              }
            </span>
          }
        </div>
      </td>
    </ng-container>
    <tr mat-row *matRowDef="let row; columns: displayedColumns;" (contextmenu)="open($event,row);"
      class="rowData" style="cursor: pointer;">
    </tr>
  </table>
</div>
