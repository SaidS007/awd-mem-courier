@if (loading) {
  <div class="loader">
    <mat-spinner></mat-spinner>
  </div>
}

@if (!loading) {
  <div class="mat-dialog-content-container">
    <div style="min-height: 150px; max-height: 100%; height: 100%;">
      <div style="display: flex; gap: 20px; padding: 15px; align-items: center; background: #F9F9F9; cursor: move;"
        cdkDrag cdkDragRootElement=".cdk-overlay-pane" cdkDragHandle>
        <span class="contact-header-image fa fa-address-card fa-2xl" style="color: var(--maarch-color-primary)"></span>
        <span class="contact-header-text">
          {{ 'lang.mergeContact' | translate }}
        </span>
      </div>
      <div style="margin: 10px">
        <div class="alert alert-danger">
          <span [innerHTML]="'lang.mergeContactWarning' | translate"></span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 32%); grid-gap: 10px;">
          <div class="fusion_contact" style="position: relative; top: 20px;">
            @for (field of this.fields; track field) {
              <div>
                <span>
                  <i class="{{ field['icon'] }}"></i>
                </span>
                {{ field['label'] }}
              </div>
            }
          </div>
          @for (contact of data.duplicate; track contact; let i = $index) {
            <div style="position: relative; margin-top: 5px;">
              @if (i === 0) {
                <span style="position: absolute; top: -15px; color: grey">
                  Coordonnées de base
                </span>
              }
              @if (i === 1) {
                <span style="position: absolute; top: -15px; color: grey">
                  Coordonnées détectées par SerenIA
                </span>
              }
              <div class="fusion_contact" style="position:relative; top: 15px;">
                @for (field of this.fields; track field) {
                  <div>
                    @if (i === 0 || (i === 1 && !field['edition'])) {
                      <mat-chip [selected]="field.selected === i" style="min-height: 25px!important; cursor: pointer"
                        [style.opacity]="contact[field['id']] ? 1 : i === 1 ? 1 : 0" (click)="chooseOption(i, field)">
                        <p [title]="contact[field['id']]">{{ contact[field['id']] }}</p>
                      </mat-chip>
                    }
                    @if (i === 1 && field['edition']) {
                      <div style="margin-top: 0px !important;">
                        <input matInput type="text"
                          [placeholder]="field['label']"
                          [(ngModel)]="contact[field['id']]"
                          style="width: 100%; height: 25px; padding: 0 10px; border-radius: 5px; border: 1px solid #ccc;">
                      </div>
                    }
                    @if (i === 1) {
                      <span>
                        @if (!field['edition']) {
                          <i class="fa fa-edit"
                            (click)="field['edition'] = !field['edition']"
                            [matTooltip]="'lang.update' | translate"
                          style="color: var(--maarch-color-primary); cursor: pointer; margin-top: 5px; margin-left: 5px"></i>
                        }
                        @if (field['edition']) {
                          <i class="fa fa-check"
                            (click)="updateField(i, field, contact[field['id']]); field['edition'] = !field['edition']"
                            [matTooltip]="'lang.validate' | translate"
                          style="color: var(--maarch-color-primary); cursor: pointer; margin-top: 5px; margin-left: 5px"></i>
                        }
                      </span>
                    }
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </div>
      <div mat-dialog-actions class="actions" style="margin-top: 20px;">
        <button mat-raised-button mat-button class="primary" (click)="onSubmit()">{{ 'lang.merge' | translate }}</button>
        <button mat-raised-button mat-button [mat-dialog-close]="">{{ 'lang.cancel' | translate }}</button>
        <button mat-raised-button mat-button (click)="createContact()" [title]="'lang.create_contact_hint' | translate">
          {{ 'lang.create_contact' | translate }}
        </button>
      </div>
    </div>
  </div>
}
