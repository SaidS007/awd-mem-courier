@if (this.control.status !== 'DISABLED') {
  <app-contact-autocomplete
    [exclusion]="'?noUsers=true&noEntities=true&noContactsGroups=true'"
    [inputMode]="true"
  style="width:100%;" (afterSelected)="getContact($event)"></app-contact-autocomplete>
}
@if (!manualAddress && emptyAddress()) {
  <button (click)="manualAddress=!manualAddress" style="cursor: pointer;">{{'lang.switchManualAddress' | translate}}</button>
}
@if (manualAddress) {
  <mat-card class="primary">
    @if (this.control.status !== 'DISABLED') {
      <mat-form-field appearance='outline' class="smallInput">
        <button mat-button matSuffix [matMenuTriggerFor]="menuDep" (click)="$event.stopPropagation();"
          [title]="'lang.targetDepartment' | translate">
          {{addressBANCurrentDepartment}}&nbsp;<i class="fa fa-chevron-down"></i>
        </button>
        <mat-menu #menuDep="matMenu">
          @for (dep of departmentList; track dep) {
            <button mat-menu-item
            (click)="addressBANCurrentDepartment = dep">{{dep}}</button>
          }
        </mat-menu>
        <mat-icon class="fa fa-search" matPrefix style="font-size: 15px; color: #3A7C00">
        </mat-icon>
        <input type="text" #autoCompleteInput [placeholder]="'lang.searchAddressBan' | translate" matInput
          [formControl]="addressBANControl" [matAutocomplete]="auto" (click)="$event.stopPropagation()"
          (focus)="resetAutocompleteAddressBan()" maxlength="128">
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="selectAddressBan($event)">
          @if (addressSectorResult.length > 0 && !addressLoading) {
            <mat-label class="title-ban">{{'lang.labelSectors' | translate | uppercase}}</mat-label>
            @for (addressSectorResult of addressSectorFilteredResult | async; track addressSectorResult) {
              <mat-option
                [value]="addressSectorResult" [title]="addressSectorResult.address">
                {{addressSectorResult.address}}
              </mat-option>
            }
          }
          @if (addressBANResult.length > 0 && !addressLoading) {
            <mat-label class="title-ban">{{'lang.labelBAN' | translate | uppercase}}</mat-label>
            @for (addressBANResult of addressBANFilteredResult | async; track addressBANResult) {
              <mat-option [value]="addressBANResult"
                [title]="addressBANResult.address">
                {{addressBANResult.address}}
              </mat-option>
            }
          }
          @if (addressBANResult.length === 0 && !addressLoading) {
            <mat-option class="autoCompleteInfoResult smallInputInfo"
              disabled [innerHTML]="addressBANInfo">
            </mat-option>
          }
          @if (addressLoading) {
            <mat-option disabled>
              <mat-spinner diameter="20"></mat-spinner>
            </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
    }
    <button mat-icon-button class="address-icon" (click)="manualAddress=!manualAddress"
      [title]="'lang.showAddress' | translate">
      <mat-icon class="fa fa-eye"></mat-icon>
    </button>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_company' | translate}}</mat-label>
      <input matInput name="company" [(ngModel)]="this.control.value.company"
        (ngModelChange)="toUpperCase('company')" [required]="functions.empty(control.value.lastname)">
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_civility' | translate}}</mat-label>
      <mat-select name="civility" [(ngModel)]="this.control.value.civility">
        @for (civ of civilities | sortBy: 'label'; track civ) {
          <mat-option [value]="civ.label">
            {{civ.label}}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_firstname' | translate}}</mat-label>
      <input matInput name="firstname" [(ngModel)]="this.control.value.firstname"
        (ngModelChange)="toUpperCase('firstname')" [required]="functions.empty(control.value.company)">
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_lastname' | translate}}</mat-label>
      <input matInput name="lastname" [(ngModel)]="this.control.value.lastname"
        (ngModelChange)="toUpperCase('lastname')" [required]="functions.empty(control.value.company)">
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_addressAdditional1' | translate}}</mat-label>
      <input matInput name="addressAdditional1" [(ngModel)]="this.control.value.addressAdditional1"
        (ngModelChange)="toUpperCase('addressAdditional1')">
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_addressNumber' | translate}}</mat-label>
      <input matInput name="addressNumber" [(ngModel)]="this.control.value.addressNumber"
        (ngModelChange)="toUpperCase('addressNumber')" required>
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_addressStreet' | translate}}</mat-label>
      <input matInput name="addressStreet" [(ngModel)]="this.control.value.addressStreet"
        (ngModelChange)="toUpperCase('addressStreet')" required>
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_addressAdditional2' | translate}}</mat-label>
      <input matInput name="addressAdditional2" [(ngModel)]="this.control.value.addressAdditional2"
        (ngModelChange)="toUpperCase('addressAdditional2')">
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_addressPostcode' | translate}}</mat-label>
      <input matInput name="addressPostcode" [(ngModel)]="this.control.value.addressPostcode"
        (ngModelChange)="toUpperCase('addressPostcode')" required>
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_addressTown' | translate}}</mat-label>
      <input matInput name="addressTown" [(ngModel)]="this.control.value.addressTown"
        (ngModelChange)="toUpperCase('addressTown')" required>
    </mat-form-field>
    <mat-form-field floatLabel="always">
      <mat-label>{{'lang.contactsParameters_addressCountry' | translate}}</mat-label>
      <input matInput #autoCompleteInput [(ngModel)]="this.control.value.addressCountry" [matAutocomplete]="matAutocompleteCountries"
        [formControl]="countryControl" [required]="registeredMailType === 'RW'">
      <mat-autocomplete #matAutocompleteCountries="matAutocomplete" isOpen="true" (optionSelected)="this.control.value.addressCountry = $event.option.value">
        @for (country of countriesFilteredResult | async; track country) {
          <mat-option [value]="country">
            {{country}}
          </mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>
  </mat-card>
}
@if (!manualAddress && !emptyAddress()) {
  <mat-card class="primary" style="min-height: 60px">
    @if (this.control.status !== 'DISABLED') {
      <button mat-icon-button class="address-icon"
        (click)="manualAddress=!manualAddress" [title]="'lang.update' | translate">
        <mat-icon class="fa fa-edit"></mat-icon>
      </button>
    }
    <div>
      {{control.value.company}}
    </div>
    <div>
      {{control.value.civility}} {{control.value.firstname}} {{control.value.lastname}}
    </div>
    <div>
      {{control.value.addressAdditional1}}
    </div>
    <div>
      {{control.value.addressNumber}} {{control.value.addressStreet}}
    </div>
    <div>
      {{control.value.addressAdditional2}}
    </div>
    <div>
      {{control.value.addressPostcode}} {{control.value.addressTown}}
    </div>
    <div>
      {{control.value.addressCountry}}
    </div>
    <button mat-icon-button class="map-icon" (click)="goTo()" [title]="'lang.openMap' | translate">
      <mat-icon class="fa fas fa-map-marked-alt"></mat-icon>
    </button>
  </mat-card>
}
