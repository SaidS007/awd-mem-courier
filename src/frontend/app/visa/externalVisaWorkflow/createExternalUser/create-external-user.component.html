<div class="mat-dialog-content-container">
    <h1 mat-dialog-title>{{(data === null ? 'lang.addOtp' : 'lang.updateOtp') | translate}}</h1>
    <div mat-dialog-content>
        @if (loading){
            <div class="loading" style="display:flex;height:100%;">
                <mat-spinner style="margin:auto;"></mat-spinner>
            </div>
        } @else {
            <div class="userForm">
                @if (sources.length > 1) {
                    <mat-form-field appearance="fill">
                        <mat-label>{{ 'lang.source' | translate }}</mat-label>
                        <mat-select #source
                            [(ngModel)]="userOTP.sourceId"
                            (selectionChange)="setCurrentSource($event.value)" required>
                            @for (source of sourceTypes; track source) {
                                <mat-optgroup [label]="(source === 'yousign' ? 'lang.youSign' : 'lang.fastParapheur') | translate">
                                    @for (item of getSources(source); track item) {
                                        <mat-option [value]="item.id" [title]="item.label" role="option">
                                            {{ item.label }}
                                        </mat-option>
                                    }
                                </mat-optgroup>
                            }
                        </mat-select>
                    </mat-form-field>
                }
                @if (searchMode) {
                    <div style="display: flex;margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <app-contact-autocomplete [exclusion]="'?noEntities=true&noContactsGroups=true'"
                                [inputMode]="true" style="width:100%;padding-bottom:10px;" (afterContactSelected)="getContact($event)" [fromExternalWorkflow]="true">
                            </app-contact-autocomplete>
                        </div>
                        <div>
                            <button mat-icon-button style="color: #3A7C00" [title]="'lang.viewSuggestions' | translate" (click)="searchMode=!searchMode">
                                <mat-icon class="fa fa-users"></mat-icon>
                            </button>
                        </div>
                    </div>
                } @else {
                    <ng-container>
                        <div class="formType">
                            <div class="formType-title">
                                {{'lang.suggestedCorrespondents' | translate}}
                            </div>
                            <div class="formType-content">
                                <div class="correspondent-list">
                                    @if (correspondentShorcuts.length === 0) {
                                        <div class="empty">
                                            {{'lang.noSuggestion' | translate}}
                                        </div>
                                    } @else {
                                        <ng-template #elseBlock>
                                            <mat-chip-list>
                                                @for (shortcut of correspondentShorcuts; track shortcut) {
                                                    <mat-chip [title]="shortcut.title"
                                                        (click)="setOtpInfoFromShortcut(shortcut)" style="cursor: pointer;font-size: 12px;min-height: 24px;">
                                                        {{shortcut.label}}
                                                    </mat-chip>
                                                }
                                            </mat-chip-list>
                                        </ng-template>
                                    }
                                </div>
                                <div>
                                    <button mat-icon-button style="color: #3A7C00" [title]="'lang.searchCorrespondent' | translate" (click)="searchMode=!searchMode">
                                        <mat-icon class="fa fa-search"></mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </ng-container>
                }
            <mat-form-field appearance="fill">
                <mat-label>{{'lang.firstname' | translate}}</mat-label>
                <input matInput #firstname type="text" maxlength="128" [(ngModel)]="userOTP.firstname" required>
            </mat-form-field>
            <mat-form-field appearance="fill">
                <mat-label>{{'lang.lastname' | translate}}</mat-label>
                <input matInput #lastname type="text" maxlength="128" [(ngModel)]="userOTP.lastname" required>
            </mat-form-field>
            <mat-form-field appearance="fill">
                <mat-label>{{'lang.phoneNumber' | translate}}</mat-label>
                <input matInput #phoneNumber type="text" [(ngModel)]="userOTP.phone" placeholder="Exemple: +33621235684"
                    [pattern]="getRegexPhone()" (keyup)="formatPhone()" required>
                <mat-hint align="start">{{ 'lang.frFormatPhone' | translate }}</mat-hint>
            </mat-form-field>
            <mat-form-field appearance="fill">
                <mat-label>{{'lang.email' | translate}}</mat-label>
                <input matInput #email type="email" [(ngModel)]="userOTP.email"
                    pattern="(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)" required>
            </mat-form-field>
            <mat-form-field floatLabel="always" appearance="fill">
                <mat-label>{{'lang.role' | translate}}</mat-label>
                <input matInput style="display: none;">
                <mat-radio-group #role style="display: flex" [(ngModel)]="userOTP.role" required>
                    @for (role of availableRoles; track role) {
                        <mat-radio-button [value]="role.id" style="flex:1" class="primary" [disabled]="role.id === 'visa' && userOTP.type === 'fast'">
                            {{ role.label }}
                        </mat-radio-button>
                    }
                </mat-radio-group>
            </mat-form-field>
                @if (currentSource.length > 1 && userOTP.role !== 'visa') {
                    <mat-form-field appearance="fill">
                        <mat-label>{{ 'lang.securityMode' | translate }}</mat-label>
                        <mat-select #securityMode [(ngModel)]="userOTP.security" required>
                            @for (mode of currentSource; track mode) {
                                <mat-option [value]="mode">
                                    {{ 'lang.' + mode | translate }}
                                </mat-option>
                            }
                        </mat-select>
                    </mat-form-field>
                }
                @if(userOTP.security) {
                    <app-maarch-message [mode]="'info'"
                        [content]="(userOTP.role === 'visa' ? 'lang.otpVisaUser' : 'lang.securityModeInfo') | translate : {mode: userOTP.security}"></app-maarch-message>
                }
        </div>
        }
    </div>
    <span class="divider-modal"></span>
    <div mat-dialog-actions class="actions">
        <button mat-raised-button mat-button class="primary" [disabled]="loading || !isValidForm()"
            (click)="addOtpUser()">{{ (this.data === null ? 'lang.validate' : 'lang.update') | translate}}</button>
        <button mat-raised-button mat-button [mat-dialog-close]="">{{'lang.cancel' | translate}}</button>
    </div>
</div>