@if (!loading) {
  <mat-list>
    @if (!functions.empty(workflowTypes)) {
      <mat-form-field>
        <mat-label>{{'lang.workflowType' | translate}}</mat-label>
        <mat-select required name="workflowTypes"
          [title]="getWorkflowTypeLabel(workflowType)"
          [(ngModel)]="workflowType">
          @for (type of workflowTypes; track type) {
            <mat-option [value]="type.id">
              {{type.label}}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    }
    @if (adminMode) {
      <app-plugin-autocomplete [labelPlaceholder]="'lang.addPerson' | translate"
        [routeDatas]="getRouteDatas()" [targetSearchKey]="'idToDisplay'"
        [subInfoKey]="'email'" (triggerEvent)="addItemToWorkflow($event)" appearance="outline"
        [fromExternalWorkflow]="canAddExternalUser()" [connectorLength]="otpConfig" [resId]="resId" (updateVisaWorkflow)="updateVisaWorkflow($event)">
      </app-plugin-autocomplete>
    }
    <div cdkDropList #dataAvailableList="cdkDropList" [cdkDropListData]="visaWorkflow.items" class="cdk-list"
      (cdkDropListDropped)="drop($event)" [cdkDropListDisabled]="!adminMode">
      @if (adminMode && visaWorkflow.items.length === 0) {
        <div class="emptyContent">
          {{'lang.noVisaWorkflow' | translate}}
        </div>
      }
      @if (!adminMode && visaWorkflow.items.length === 0) {
        <div class="emptyContent">
          {{'lang.cannotAddVisaCircuit' | translate}}
        </div>
      }
      @for (diffusion of visaWorkflow.items; track diffusion; let i = $index) {
        <mat-list-item disableRipple cdkDrag
          class="columns workflow" [cdkDragDisabled]="!canManageUser()"
          [class.notDraggable]="!canManageUser()" [class.notEditable]="!adminMode"
          [class.processed]="diffusion.process_date != null && diffusion.status === 'VAL'"
          [class.interrupt]="(diffusion.process_date != null && diffusion.status !== 'VAL') || diffusion.status === 'END'">
          @if ((getCurrentVisaUserIndex() === i && !adminMode) && diffusion.status !== 'END') {
            <mat-icon
              class="fa fa-chevron-right fa-2x" mat-list-icon style="color:#006841">
            </mat-icon>
          }
          <mat-icon class="fa fa-2x" style="color: #3A7C00; position: relative;" [class.avatar]="!functions.empty(diffusion.picture)"
            [class.fa-user]="functions.empty(diffusion.picture) && (diffusion.isValid || (diffusion.process_date === null && diffusion.delegatedBy === null))"
            [class.fa-user-friends]="diffusion.process_date != null && diffusion.delegatedBy !== null"
            [class.fa-user-slash]="!diffusion.isValid"
            [title]="!diffusion.isValid ? ('lang.userNotValid' | translate) : ''" mat-list-icon
            [class.invalid]="!diffusion.hasPrivilege || !diffusion.isValid"
            [style.background-image]="!functions.empty(diffusion.picture) ? 'url('+diffusion.picture+')' : ''"
            >
          </mat-icon>
          @if ((!adminMode || diffusion.process_date != null) && diffusion.isValid) {
            <mat-icon mat-list-icon class="fa-2x fa"
              [title]="'lang.' + (diffusion.status | lowercase) + 'Status' | translate"
              [class.fa-hourglass]="diffusion.process_date == null && diffusion.status !== 'END'"
              [class.fa-thumbs-up]="diffusion.process_date != null && diffusion.status === 'VAL'"
              [class.fa-thumbs-down]="diffusion.process_date != null && diffusion.status === 'REF'"
              [class.fa-hand-paper]="diffusion.process_date != null && diffusion.status === 'STOP'"
              [class.fa-times]="diffusion.status === 'END'"
              [class.valid]="diffusion.process_date != null && diffusion.status === 'VAL'"
              [class.invalid]="(diffusion.process_date != null && diffusion.status !== 'VAL') || diffusion.status === 'END'"
            style="opacity:0.5;"></mat-icon>
          }
          <div mat-line class="workflowLine">
            <div class="workflowLineContainer">
              <div class="workflowLineLabel" style="white-space: initial" [class.unauthorized]="!diffusion.hasPrivilege || !diffusion.isValid" [title]="diffusion.labelToDisplay">
                {{diffusion.labelToDisplay}}
                @if (diffusion.process_date != null && diffusion.delegatedBy !== null) {
                  <mat-icon mat-list-icon class="fas fa-exclamation-circle"
                    [title]="('lang.insteadOf' | translate) + ' ' + diffusion.delegatedBy"
                  style="opacity:0.5;font-size: 125%;height: 15px;color: red;cursor: help;"></mat-icon>
                }
              </div>
              @if (diffusion.process_date != null && diffusion.status === 'VAL') {
                <div
                  class="workflowLineProcessDate accent" title='{{diffusion.process_date | fullDate}}'>
                  {{diffusion.requested_signature ? ('lang.signedUserDate' | translate) : ('lang.approvedUserDate' | translate)}} {{diffusion.process_date | timeAgo : 'full'}}
                </div>
              }
              @if (diffusion.process_date != null && diffusion.status !== 'VAL') {
                <div
                  class="workflowLineProcessDate warn" title='{{diffusion.process_date | fullDate}}'>
                  {{ diffusion.status === 'STOP' ? ('lang.interrupted' | translate) : ('lang.refused' | translate) }} {{diffusion.process_date | timeAgo : 'full'}}
                </div>
              }
              @if (diffusion.process_date == null && this.getLastVisaUser()?.status === 'REF') {
                <div
                  class="workflowLineProcessDate warn" title='{{this.getLastVisaUser()?.process_date | fullDate}}'>
                  {{ 'lang.interrupted' | translate }} {{ this.getLastVisaUser()?.process_date | timeAgo : 'full' }}
                </div>
              }
            </div>
            @if (diffusion.hasPrivilege && diffusion.isValid) {
              <div>
                <ng-container>
                  @if (canManageUser() && diffusion.item_id === null && diffusion?.externalInformations && canAddExternalUser()) {
                    <button mat-icon-button
                      (click)="openCreateUserOtp(diffusion)" [title]="'lang.updateOtp' | translate">
                      <mat-icon class="fas fa-edit" style="color: #3A7C00"></mat-icon>
                    </button>
                  }
                  <button class="currentRoleButton" [class.readonly]="!adminMode" [color]="diffusion.role === 'visa' ? 'default':'primary'" mat-raised-button
                    title="{{'lang.' + diffusion.role + (diffusion.role === 'sign' ? 'User' : '') | translate}}"
                  [matMenuTriggerFor]="rolesMenu" [disabled]="!adminMode">{{'lang.' + diffusion.role + (diffusion.role === 'sign' ? 'User' : '') | translate}}</button>
                  <mat-menu #rolesMenu="matMenu">
                    @for (role of diffusion.availableRoles; track role) {
                      <button mat-menu-item (click)="diffusion.role=role" [class.selected]="diffusion.role===role" [disabled]="!isValidRole(i,role,diffusion.role)">{{'lang.'+ role + (role === 'sign' ? 'User' : '') | translate}}</button>
                    }
                  </mat-menu>
                </ng-container>
              </div>
            }
            @if (!diffusion.hasPrivilege) {
              <div class="invalid">
                {{'lang.noPrivileges' | translate}}
              </div>
            }
            @if (!diffusion.isValid) {
              <div class="invalid invalidMsg">
                {{'lang.userNotValid' | translate}}
              </div>
            }
          </div>
          @if (canManageUser()) {
            <button mat-icon-button (click)="deleteItem(i)">
              <mat-icon class="fa fa-times" style="color:#8e3e52"></mat-icon>
            </button>
          }
        </mat-list-item>
      }
    </div>
  </mat-list>
}
