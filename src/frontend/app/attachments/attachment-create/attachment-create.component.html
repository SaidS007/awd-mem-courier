<div class="attach-container">
  @if (sendingData) {
    <div class="example-loading-shade">
      <mat-spinner></mat-spinner>
    </div>
  }
  <h1 mat-dialog-title>
    <span style="flex: 1;">
      {{'lang.attachmentCreation' | translate}}
    </span>
    @if (!loading) {
      <button [title]="'lang.close' | translate" mat-icon-button (click)="dialogRef.close();">
        <mat-icon class="fa fa-times"></mat-icon>
      </button>
    }</h1>
    <mat-dialog-content class="attach-content">
      @if (loading) {
        <div class="loading">
          <mat-spinner style="margin:auto;"></mat-spinner>
        </div>
      }
      @if (!loading) {
        <mat-tab-group #pjList style="width: 100%;" [(selectedIndex)]="indexTab" (selectedIndexChange)="updateFile($event)">
          @for (attachment of attachments; track attachment; let i = $index) {
            <mat-tab [disabled]="isDocLoading()">
              <ng-template mat-tab-label>
                <span [class.complete]="isPjValid(i)">{{'lang.attachmentShort' | translate}} nÂ°{{i+1}}&nbsp;@if (isPjValid(i)) {
                  <i
                  class="fa fa-check"></i>
                  }@if (attachments.length > 1) {
                  <button mat-icon-button [disabled]="isDocLoading()" style="color:#8e3e52"
                    [title]="'lang.delAttachment' | translate" (click)="$event.stopPropagation();removePj(i)">
                    <mat-icon class="fa fa-minus"></mat-icon>
                  </button>
                }</span>
              </ng-template>
              <div style="height:100%;overflow: auto;">
                @if (!loading) {
                  <div class="attachment-form col-md-3 col-sm-12">
                    <div class="attachment-form-item">
                      <app-plugin-select-search [label]="'lang.type' | translate" [placeholderLabel]="'lang.type' | translate"
                        [formControlSelect]="attachment['type']" [datas]="attachmentsTypes"
                        (afterSelected)="getAttachType($event, i)" style="width:100%;">
                      </app-plugin-select-search>
                      <div class="fieldState">
                        @if (attachment['type'].hasError('required') && attachment['type'].untouched) {
                          <i class="fas fa-asterisk fieldRequired"
                          ></i>
                        }
                        @if (attachment['type'].touched && attachment['type'].hasError('required')) {
                          <i class="fas fa-exclamation-triangle fieldError"
                          ></i>
                        }
                        @if (attachment['type'].valid && !isEmptyField(attachment['type'])) {
                          <i class="fas fa-check fieldFull"
                          ></i>
                        }
                      </div>
                    </div>
                    <div class="attachment-form-item">
                      <mat-form-field class="input-form">
                        <input matInput placeholder="{{'lang.subject' | translate}}" maxlength="255" [formControl]="attachment['title']">
                      </mat-form-field>
                      <div class="fieldState">
                        @if (attachment['title'].hasError('required') && attachment['title'].untouched) {
                          <i class="fas fa-asterisk fieldRequired"
                          ></i>
                        }
                        @if (attachment['title'].touched && attachment['title'].hasError('required')) {
                          <i class="fas fa-exclamation-triangle fieldError"
                          ></i>
                        }
                        @if (attachment['title'].valid && !isEmptyField(attachment['title'])) {
                          <i class="fas fa-check fieldFull"
                          ></i>
                        }
                      </div>
                    </div>
                    <div class="attachment-form-item">
                      @if (resourceContacts.length > 1) {
                        <app-plugin-select-search  [label]="'lang.selectContact' | translate"
                          [placeholderLabel]="'lang.selectContact' | translate" [datas]="resourceContacts"
                          [returnValue]="'object'" [formControlSelect]="selectedContact"
                          (afterSelected)="selectContact($event)" style="width:100%;">
                        </app-plugin-select-search>
                      }
                      <div class="fieldState">
                        @if (canSendMass()) {
                          <button mat-icon-button style="color: #3A7C00"
                            [title]="sendMassMode ? ('lang.disableMailing' | translate) : ('lang.enableMailing' | translate)"
                            [class.active]="sendMassMode" (click)="toggleSendMass()">
                            <mat-icon class="fas fa-mail-bulk"></mat-icon>
                          </button>
                        }
                        <i class="fas fa-asterisk noMandatory"></i>
                      </div>
                    </div>
                    @if (sendMassMode) {
                      <div class="attachment-form-item" style="display: block;">
                        <app-maarch-message [content]="'lang.mailingMsg' | translate: {nbContacts: getNbContacts()}"></app-maarch-message>
                      </div>
                    }
                    @if (!sendMassMode) {
                      <div class="attachment-form-item">
                        @if (!loadingContact) {
                          <app-contact-autocomplete [controlAutocomplete]="attachment['recipient']"
                            style="width:100%;" [singleMode]="true"
                            (retrieveDocumentEvent)="appDocumentViewer.saveDocService()">
                          </app-contact-autocomplete>
                        }
                        <div class="fieldState">
                          <i class="fas fa-asterisk noMandatory"></i>
                        </div>
                      </div>
                    }
                    <div class="attachment-form-item">
                      <mat-form-field class="input-form input-date" (click)="picker.open()"
                        style="cursor:pointer;">
                        <mat-label>{{'lang.expectedReturnDate' | translate}}</mat-label>
                        <input [formControl]="attachment['validationDate']" matInput [matDatepicker]="picker"
                          [placeholder]="'lang.expectedReturnDate' | translate" [min]="now" readonly
                          style="cursor:pointer;">
                        @if (!attachment['validationDate'].value) {
                          <mat-datepicker-toggle matSuffix [for]="picker"
                            >
                          </mat-datepicker-toggle>
                        }
                        <mat-datepicker [touchUi]="appService.getViewMode()" #picker></mat-datepicker>
                        @if (attachment['validationDate'].value && !attachment['validationDate'].disabled) {
                          <button mat-button class="warn" matSuffix mat-icon-button
                            (click)="$event.stopPropagation();attachment['validationDate'].reset();"
                            [title]="'lang.eraseValue' | translate">
                            <mat-icon style="color:#8e3e52" class="fa fa-calendar-times">
                            </mat-icon>
                          </button>
                        }
                      </mat-form-field>
                      <div class="fieldState">
                        @if (attachment['validationDate'].valid && isEmptyField(attachment['validationDate'])) {
                          <i class="fas fa-asterisk noMandatory"
                          ></i>
                        }
                        @if (attachment['validationDate'].valid && !isEmptyField(attachment['validationDate'])) {
                          <i class="fas fa-check fieldFull"
                          ></i>
                        }
                      </div>
                    </div>
                  </div>
                }
                <div class="documentContent col-md-9 col-sm-12">
                  <app-document-viewer #appDocumentViewer style="height:100%;width:100%;position: relative;"
                    [editMode]="true" [mode]="'attachment'" (triggerEvent)="setDatasViewer($event, i)">
                  </app-document-viewer>
                  <div class="fieldState stateDoc">
                    @if (attachment['encodedFile'].touched && attachment['encodedFile'].hasError('required')) {
                      <i class="fas fa-exclamation-triangle fieldError"
                      ></i>
                    }
                  </div>
                  <div style="position: absolute;right: 20px;top: -55px;width:40px;height:40px;">
                    <app-tools-informations style="position:fixed;z-index:3;text-align: left;" [resId]="data.resIdMaster"></app-tools-informations>
                  </div>
                </div>
              </div>
            </mat-tab>
          }
          <mat-tab disabled class="addPJ">
            <ng-template mat-tab-label>
              <span><button mat-icon-button [disabled]="sendMassMode || isDocLoading()" [title]="'lang.newAttachment' | translate"
                (click)="$event.stopPropagation();newPj()">
                <mat-icon class="fa fa-plus"></mat-icon>
              </button></span>
            </ng-template>
          </mat-tab>
        </mat-tab-group>
      }
    </mat-dialog-content>
    <div mat-dialog-actions class="actions">
      @if (creationMode && !loading) {
        <button mat-raised-button class="primary" (click)="onSubmit()"
        [disabled]="canValidatePj()">{{'lang.validate' | translate}}</button>
      }
      @if (sendMassMode && !loading) {
        <button mat-raised-button class="primary" (click)="onSubmit('mailing')"
        [disabled]="canValidatePj()">{{'lang.mailing' | translate}}</button>
      }
      @if (creationMode && !loading) {
        <button mat-raised-button mat-button [disabled]="canValidatePj()"
        [mat-dialog-close]="">{{'lang.cancel' | translate}}</button>
      }
    </div>
  </div>
