<mat-sidenav-container autosize class="maarch-container">
  <ng-template #adminMenuTemplate>
    @if (!loading) {
      <mat-nav-list>
        <h3 mat-subheader>{{'lang.actions' | translate}}</h3>
        <button mat-list-item (click)="openAbsModal()">
          @if (!haveAbsScheduled) {
            <mat-icon style="color:#8e3e52" mat-list-icon class="fa fa-plane"></mat-icon>
          }
          @if (haveAbsScheduled) {
            <mat-icon style="color:#8e3e52" mat-list-icon class="fa fa-plane-slash"></mat-icon>
          }
          <p mat-line>
            {{ (!haveAbsScheduled ? 'lang.activateMyAbs' : 'lang.cancelModifyAbsence') | translate}}
          </p>
        </button>
        @if (user.canModifyPassword) {
          <button mat-list-item (click)="changePasswd();">
            <mat-icon mat-list-icon style="color: #3A7C00" class="fa fa-key"></mat-icon>
            <p mat-line>
              {{'lang.changeMyPassword' | translate}}
            </p>
          </button>
        }
        <button mat-list-item [title]="'lang.copyAuthTokenDesc' | translate" (click)="copyAuthToken();">
          <mat-icon mat-list-icon style="color: #3A7C00" class="fas fa-fingerprint"></mat-icon>
          <p mat-line>
            {{'lang.copyAuthToken' | translate}}
          </p>
        </button>
      </mat-nav-list>
    }
  </ng-template>
  <mat-sidenav-content>
    <div class="bg-head">
      <div class="bg-head-title" [class.customContainerRight]="appService.getViewMode()">
        <div class="bg-head-title-label">
          <app-header-left></app-header-left>
        </div>
        <div class="bg-head-title-tool">
          <app-header-right></app-header-right>
        </div>
      </div>
      <div class="bg-head-content" [class.fullContainer]="appService.getViewMode()">
      </div>
    </div>
    <div class="container" [class.fullContainer]="appService.getViewMode()">
      <div class="container-content">
        @if (loading) {
          <div style="display:flex;height:100%;">
            <mat-spinner style="margin:auto;"></mat-spinner>
          </div>
        }
        @if (!loading) {
          <mat-card class="card-app-content">
            <mat-tab-group [selectedIndex]="selectedIndex" (selectedTabChange)="initComponents($event)">
              <mat-tab label="{{'lang.myInformations' | translate}}">
                @if (showPassword) {
                  <div style="margin-bottom: 5%">
                    <form [formGroup]="firstFormGroup">
                      <div class="form-group">
                        <mat-form-field style="padding:10px;">
                          <input matInput placeholder="{{'lang.typeCurrentPassword' | translate}}"
                            formControlName="currentPasswordCtrl" required
                            [type]="hidePassword ? 'password' : 'text'">
                          <mat-icon matSuffix (click)="hidePassword = !hidePassword" class="fa fa-2x"
                          [ngClass]="[hidePassword ? 'fa-eye-slash' : 'fa-eye']"></mat-icon>
                          @if (firstFormGroup.controls['currentPasswordCtrl'].hasError('required')) {
                            <mat-error
                              >
                            {{'lang.requiredField' | translate}}</mat-error>
                          }
                        </mat-form-field>
                      </div>
                      <div class="form-group">
                        <div style="text-align:center;color: rgba(0,0,0,0.54);font-size: 75%;">
                        {{this.ruleText}}</div>
                        <div class="col-sm-6" style="padding-left:0px;padding-right: 0px;">
                          <mat-form-field style="padding:10px;">
                            <input matInput #inputPasswd
                              placeholder="{{'lang.typeNewPassword' | translate}}"
                              formControlName="newPasswordCtrl" required
                              [type]="hidePassword ? 'password' : 'text'">
                            <mat-icon matSuffix (click)="hidePassword = !hidePassword"
                              class="fa fa-2x"
                            [ngClass]="[hidePassword ? 'fa-eye-slash' : 'fa-eye']"></mat-icon>
                            @if (validPassword) {
                              <mat-hint>
                                <i style="color:#006841" class="fa fa-check"></i>
                                <span class="accent">{{'lang.passwordValid' | translate}}</span>
                              </mat-hint>
                            }
                            <mat-error>{{getErrorMessage()}}</mat-error>
                          </mat-form-field>
                        </div>
                        <div class="col-sm-6" style="padding-left:0px;padding-right:0px;">
                          <mat-form-field style="padding:10px;">
                            <input matInput #inputPasswd2
                              placeholder="{{'lang.retypeNewPassword' | translate}}" required
                              [type]="hidePassword ? 'password' : 'text'"
                              formControlName="retypePasswordCtrl">
                            <mat-icon matSuffix (click)="hidePassword = !hidePassword"
                              class="fa fa-2x"
                            [ngClass]="[hidePassword ? 'fa-eye-slash' : 'fa-eye']"></mat-icon>
                            @if (!firstFormGroup.controls['retypePasswordCtrl'].hasError('mismatch') && firstFormGroup.controls['retypePasswordCtrl'].value != '') {
                              <mat-hint
                                >
                                <i style="color:#006841" class="fa fa-check"></i>
                                <span class="accent">{{'lang.passwordMatch' | translate}}</span>
                              </mat-hint>
                            }
                            <mat-error>{{'lang.passwordNotMatch' | translate}} !</mat-error>
                          </mat-form-field>
                        </div>
                      </div>
                      @if (passwordRules.renewal.enabled || passwordRules.historyLastUse.enabled) {
                        <div
                          class="form-group">
                          <div class="col-sm-12" style="padding-left:0px;padding-right:0px;">
                            <div class="alert alert-warning" role="alert" [innerHTML]="otherRuleText"
                            style="text-align:center;"></div>
                          </div>
                        </div>
                      }
                      <div class="form-group">
                        <div style="text-align:center;">
                          <button mat-raised-button class="primary" type="button"
                            (click)="updatePassword()"
                          [disabled]="!firstFormGroup.valid">{{'lang.update' | translate}}</button>
                          <button mat-raised-button type="button"
                          (click)="showPassword=false">{{'lang.cancel' | translate}}</button>
                        </div>
                      </div>
                    </form>
                  </div>
                }
                @if (!showPassword) {
                  <form class="form-horizontal" (ngSubmit)="onSubmit()" #profileForm="ngForm"
                    >
                    <div class="form-group">
                      <div class="col-sm-12">
                        <div class="pull-left">
                          <div class="avatar" style="font-size:90px;text-align:center;">
                            <i class="fa fa-user" style="font-size:90px;padding-top:5px;"></i>
                          </div>
                        </div>
                        <div class="input-group">
                          <mat-form-field>
                            <input matInput type="text" title="{{'lang.id' | translate}}"
                              value="{{user.user_id}}" placeholder="{{'lang.id' | translate}}"
                              disabled>
                          </mat-form-field>
                        </div>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="col-sm-5" style="font-weight:bold;">
                        <mat-form-field>
                          <input matInput type="text" id="lastname" name="lastname"
                            title="{{'lang.lastname' | translate}}"
                            placeholder="{{'lang.lastname' | translate}}"
                            [(ngModel)]="user.lastname" required>
                        </mat-form-field>
                      </div>
                      <div class="col-sm-5" style="font-weight:bold;">
                        <mat-form-field>
                          <input matInput type="text" id="firstname" name="firstname"
                            title="{{'lang.firstname' | translate}}"
                            placeholder="{{'lang.firstname' | translate}}"
                            [(ngModel)]="user.firstname" required>
                        </mat-form-field>
                      </div>
                      <div class="col-sm-2" style="font-style:italic;">
                        <mat-form-field>
                          <input matInput type="text" id="initials" name="initials"
                            title="{{'lang.initials' | translate}}"
                            placeholder="{{'lang.initials' | translate}}"
                            [(ngModel)]="user.initials">
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="col-sm-12">
                        <mat-form-field>
                          <input matInput type="tel" id="phone" name="phone"
                            title="{{'lang.phoneNumber' | translate}}"
                            placeholder="{{'lang.phoneNumber' | translate}}"
                            [(ngModel)]="user.phone" pattern="\+?((|\ |\.|\(|\)|\-)?(\d)*)*\d$">
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="form-group">
                      <div class="col-sm-12">
                        <mat-form-field>
                          <input matInput type="email" id="mail" name="mail"
                            title="{{'lang.email' | translate}}"
                            placeholder="{{'lang.email' | translate}}" [(ngModel)]="user.mail"
                            pattern="(^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$)" required>
                        </mat-form-field>
                      </div>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                      <div style="text-align:center;">
                        <button mat-raised-button class="primary" type="submit"
                        [disabled]="!profileForm.form.valid">{{'lang.update' | translate}}</button>
                      </div>
                    </div>
                  </form>
                }
              </mat-tab>
              <mat-tab label="{{'lang.myParameters' | translate}}">
                <mat-accordion>
                  <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon class="fa fa-file-word"
                        style="font-size:25px;width:50px; color: #3A7C00"></mat-icon>
                        <span>{{'lang.editorOption' | translate}}</span>
                      </mat-panel-title>
                      @if (!appService.getViewMode()) {
                        <mat-panel-description>
                          {{'lang.editorOptionAdmin' | translate}}
                        </mat-panel-description>
                      }
                    </mat-expansion-panel-header>
                    <app-editor-option [docEdition] = "user.preferences.documentEdition"></app-editor-option>
                  </mat-expansion-panel>
                  <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon class="fa fa-inbox"
                        style="font-size:25px;width:50px; color: #3A7C00"></mat-icon>
                        <mat-icon class="fa fa-magic"
                          style="position: absolute;margin-left: 30px;margin-top: -10px; color: #3A7C00">
                        </mat-icon>
                        <span>{{'lang.basketsColor' | translate}}</span>
                      </mat-panel-title>
                      @if (!appService.getViewMode()) {
                        <mat-panel-description>
                          {{'lang.basketsColorAdmin' | translate}}
                        </mat-panel-description>
                      }
                    </mat-expansion-panel-header>
                    <app-basket-color [userGroupBaskets]="user.regroupedBaskets"></app-basket-color>
                  </mat-expansion-panel>
                  <mat-expansion-panel [expanded]="myBasketExpansionPanel">
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon class="fa fa-inbox"
                        style="font-size:25px;width:50px; color: #3A7C00"></mat-icon>
                        <mat-icon class="fa fa-reply"
                          style="position: absolute;margin-left: 30px;margin-top: -10px; color: #3A7C00">
                        </mat-icon>
                        {{'lang.myBaskets' | translate}}
                      </mat-panel-title>
                      @if (!appService.getViewMode()) {
                        <mat-panel-description>
                          {{'lang.myBasketsDesc' | translate}}
                        </mat-panel-description>
                      }
                    </mat-expansion-panel-header>
                    <app-my-baskets [userBaskets]="user.baskets" [redirectedBaskets]="user.redirectedBaskets" [assignedBaskets]="user.assignedBaskets" (redirectedBasketsEvent)="toggleRedirection($event)">
                    </app-my-baskets>
                  </mat-expansion-panel>
                  <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon class="fa fa-envelope"
                        style="font-size:25px;width:50px; color: #3A7C00"></mat-icon>
                        {{'lang.mySignMail' | translate}}
                      </mat-panel-title>
                      @if (!appService.getViewMode()) {
                        <mat-panel-description>
                          {{'lang.mySignMailDesc' | translate}}
                        </mat-panel-description>
                      }
                    </mat-expansion-panel-header>
                    <ng-template matExpansionPanelContent>
                      <app-mail-signatures-administration mode="private"></app-mail-signatures-administration>
                    </ng-template>
                  </mat-expansion-panel>
                  <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon class="fa fa-certificate"
                        style="font-size:25px;width:50px; color: #3A7C00"></mat-icon>
                        {{'lang.mySignSignatureBook' | translate}}
                      </mat-panel-title>
                      @if (!appService.getViewMode()) {
                        <mat-panel-description>
                          {{'lang.mySignSignatureBookDesc' | translate}}
                        </mat-panel-description>
                      }
                    </mat-expansion-panel-header>
                    @if (user.status !== 'ABS') {
                      <app-signature-book
                        [signatureModel]="signatureModel"
                        [userSignatures]="user.signatures"
                        [loadingSign]="loadingSign"
                        [externalIdMaarchParapheur]="user.external_id[authService?.externalSignatoryBook?.id]"> <!-- EDISSYUM - NCH01 Fix pour Ã©viter un message d'erreur lors de la connexion d'un utilisateur ABS | Rajout du *ngIf -->
                      </app-signature-book>
                    }
                  </mat-expansion-panel>
                  <mat-expansion-panel>
                    <mat-expansion-panel-header>
                      <mat-panel-title>
                        <mat-icon class="fas fa-cubes"
                        style="font-size:25px;width:50px; color: #3A7C00"></mat-icon>
                        {{'lang.otherPlugins' | translate}}
                      </mat-panel-title>
                      @if (!appService.getViewMode()) {
                        <mat-panel-description>
                          {{'lang.otherPluginsDesc' | translate}}
                        </mat-panel-description>
                      }
                    </mat-expansion-panel-header>
                  </mat-expansion-panel>
                </mat-accordion>
              </mat-tab>
              <mat-tab label="{{'lang.myContactsGroups' | translate}}">
                <ng-template matTabContent>
                  <app-profile-contacts-groups></app-profile-contacts-groups>
                </ng-template>
              </mat-tab>
              <mat-tab label="{{'lang.myHistoric' | translate}}">
                <ng-template matTabContent>
                  <app-profile-history></app-profile-history>
                </ng-template>
              </mat-tab>
            </mat-tab-group>
          </mat-card>
        }
      </div>
    </div>
  </mat-sidenav-content>

  <mat-sidenav #snav2 [mode]="appService.getViewMode() ? 'over' : 'side'" [fixedInViewport]="appService.getViewMode()"
    fixedTopGap="56" position='end' [opened]="appService.getViewMode() ? false : true"
    style="overflow-x:hidden;max-width:500px;">

    <mat-list>
      <h3 mat-subheader>{{'lang.groups' | translate}}</h3>
      @for (userGroup of user.groups; track userGroup) {
        <mat-list-item>
          <mat-icon mat-list-icon class="fa fa-users" style="color: #3A7C00"></mat-icon>
          <h4 mat-line>{{userGroup.group_desc}}</h4>
          <p mat-line>
            <mat-form-field style="font-size:10px;">
              <input matInput type="text" id="role" name="role" title="{{'lang.role' | translate}}"
                placeholder="{{'lang.role' | translate}}" [(ngModel)]="userGroup.role" disabled>
              <mat-hint matTooltip="{{'lang.perimeter' | translate}}">{{userGroup.mem_comment}}</mat-hint>
            </mat-form-field>
          </p>
        </mat-list-item>
      }
      <mat-divider></mat-divider>
      <h3 mat-subheader>{{'lang.entities' | translate}}</h3>
      @for (userEntity of user.entities; track userEntity) {
        <mat-list-item>
          @if (userEntity.primary_entity == 'Y') {
            <mat-icon style="color: #3A7C00" mat-list-icon class="fa fa-sitemap">
            </mat-icon>
          }
          @if (userEntity.primary_entity != 'Y') {
            <mat-icon mat-list-icon class="fa fa-sitemap"
              style="position:relative; color: #3A7C00">
              <!--<button mat-icon-button
              style="cursor:pointer;position: absolute;right: -20px;top: -20px;font-size:10px;"
              (click)="updatePrimaryEntity(userEntity)" matTooltip="{{'lang.entityTooglePrimary' | translate}}">
              <mat-icon class="fa fa-arrow-up"></mat-icon>
            </button>-->
          </mat-icon>
        }
        <h4 mat-line [ngStyle]="{'font-weight': userEntity.primary_entity == 'Y' ? 'bold' : 'normal'}"
          matTooltip="{{userEntity.entity_label}}">
          {{userEntity.entity_label}}
          @if (userEntity.primary_entity == 'Y') {
            <span class="label label-primary"
            style="font-weight:normal">{{'lang.primary' | translate}}</span>
          }
        </h4>
        <p mat-line>
          <mat-form-field style="font-size:10px;">
            <input matInput type="text" id="role" name="role" title="{{'lang.role' | translate}}"
              placeholder="{{'lang.role' | translate}}" [(ngModel)]="userEntity.user_role" disabled>
          </mat-form-field>
        </p>
      </mat-list-item>
    }
  </mat-list>
</mat-sidenav>
</mat-sidenav-container>
