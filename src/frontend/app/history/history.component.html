@if (isLoadingResults) {
  <div class="example-loading-shade">
    @if (isLoadingResults) {
      <mat-spinner></mat-spinner>
    }
  </div>
}
<div class="table-head">
  <div class="table-head-result">
    <form (ngSubmit)="directSearchHistory()">
      <mat-form-field floatLabel="never" style="font-size: 13px;">
        <input type="text" #autoCompleteInput [matAutocomplete]="auto" [placeholder]="'lang.filterBy' | translate" matInput
          [formControl]="searchHistory" (click)="$event.stopPropagation()" maxlength="128">
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="addItemFilter($event.option)"
          (opened)="initFilterListHistory()">
          @if (loadingFilters) {
            <mat-option disabled>
              <div style="display: flex;justify-content: center;">
                <mat-spinner diameter="35"></mat-spinner>
              </div>
            </mat-option>
          }
          @if (filterList!==null && !loadingFilters) {
            @for (keyVal of filterList | keyvalue; track keyVal) {
              @if ((filteredList[keyVal.key] | async)?.length > 0) {
                <mat-optgroup [label]="'lang.' + keyVal.key | translate"
                  class="filterList">
                  @for (filter of filteredList[keyVal.key] | async | sortBy : 'label'; track filter) {
                    <mat-option [id]="keyVal.key" [style.color]="!filter.used ? filterColor[keyVal.key] : ''"
                      [value]="filter" [disabled]="filter.used">
                      {{filter.label}}
                    </mat-option>
                  }
                </mat-optgroup>
              }
            }
          }
        </mat-autocomplete>
        <button mat-button matSuffix mat-icon-button type="submit" (click)="directSearchHistory()" [title]="'lang.search' | translate" style="float: right">
          <mat-icon style="color: #3A7C00" class="fa fa-search">
          </mat-icon>
        </button>
        @if (searchHistory.value) {
          <button mat-button matSuffix mat-icon-button
            (click)="searchHistory.setValue(''); directSearchHistory()" [title]="'lang.search' | translate"
            style="float: right" aria-label="Clear">
            <mat-icon class="fas fa-times" style="color:#B3B3B3"></mat-icon>
          </button>
        }
      </mat-form-field>
    </form>
  </div>
  @if (privilegeService.hasCurrentUserPrivilege('view_full_history') && privilegeService.hasCurrentUserPrivilege('view_doc_history')) {
    <button mat-icon-button style="color: #3A7C00" [title]="!fullHistoryMode ? ('lang.viewAllHistory' | translate) : ('lang.viewActionsHistory' | translate)" (click)="switchHistoryMode()">
      <mat-icon class="fas" [class.fa-exchange-alt]="fullHistoryMode" [class.fa-history]="!fullHistoryMode"></mat-icon>
    </button>
  }
  <div class="table-head-tool">
    <span style="position: relative;">
      <mat-paginator #paginatorHistoryList
        [class.pageInput]="router.url.includes('administration/history')"
        [length]="resultsLength"
        [hidePageSize]="resultsLength === 0"
        [pageSizeOptions]="[10, 25, 50, 100, 150]" (page)="handlePageEvent($event)">
      </mat-paginator>
      @if (router.url.includes('administration/history')) {
        <app-set-page
          [paginator]="paginator"
          [currentPage]="currentPage"
          [pageLength]="pageLength">
        </app-set-page>
      }
      <!-- <app-select-page [class.noResult]="resultsLength === 0" [paginator]="paginatorHistoryList"></app-select-page> -->
    </span>
  </div>
</div>
<div [class.table-admin]="resId === null">
  <div class="filterBadges">
    @for (keyVal of filterUsed | keyvalue; track keyVal) {
      @if (['startDate','endDate'].indexOf(keyVal.key) === -1) {
        @for (filter of filterUsed[keyVal.key]; track filter; let i = $index) {
          <span class="label"
            [style.background]="filterColor[keyVal.key]" [title]="'lang.' + keyVal.key | translate"
            (click)="removeItemFilter(filter,keyVal.key,i)">{{filter.label}}
            <i class="fa fa-times-circle"></i></span>
          }
        }
      }
    </div>
    <mat-table id="history-list" #tableHistoryListSort="matSort" [dataSource]="data" matSort matSortActive="event_date"
      matSortDirection="desc" style="width:100%;">
      <ng-container matColumnDef="event_date">
        <mat-header-cell *matHeaderCellDef mat-sort-header>{{'lang.event' | translate}}</mat-header-cell>
        <mat-cell mat-cell *matCellDef="let element" [title]="element.event_date | fullDate"
          [class.smallText]="resId !== null">
          @if (resId !== null) {
            <div style="font-size: 10px;">
              {{element.userLabel}}
            </div>
          }
          <div>
            {{element.event_date  | timeAgo : 'full' | ucfirst}}
          </div>
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="record_id">
        <mat-header-cell *matHeaderCellDef>{{'lang.technicalId' | translate}}</mat-header-cell>
        <mat-cell mat-cell *matCellDef="let element">
          {{element.record_id}}
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="userLabel">
        <mat-header-cell *matHeaderCellDef mat-sort-header>{{'lang.user' | translate | ucfirst}}</mat-header-cell>
        <mat-cell *matCellDef="let element">
        {{element.userLabel}} </mat-cell>
      </ng-container>
      <ng-container matColumnDef="info">
        <mat-header-cell *matHeaderCellDef mat-sort-header style="flex: 2;">{{'lang.information' | translate}}
        </mat-header-cell>
        <mat-cell *matCellDef="let element" style="flex: 2;">
          {{element.info}}
        </mat-cell>
      </ng-container>
      <ng-container matColumnDef="remote_ip">
        <mat-header-cell *matHeaderCellDef mat-sort-header>{{'lang.ip' | translate}}
        </mat-header-cell>
        <mat-cell *matCellDef="let element">
        {{element.remote_ip}} </mat-cell>
      </ng-container>
      @if (resId === null) {
        <mat-header-row *matHeaderRowDef="displayedColumnsHistory"></mat-header-row>
      }
      <mat-row *matRowDef="let row; columns: displayedColumnsHistory;">
      </mat-row>
    </mat-table>
    <div class="mat-paginator mat-paginator resultLength">
      {{resultsLength}} {{'lang.elements' | translate}}
    </div>
  </div>
