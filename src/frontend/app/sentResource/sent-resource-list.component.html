@if (loading) {
  <div class="loading">
    <mat-spinner></mat-spinner>
  </div>
} @else {
  @if (sentResources.length == 0) {
    <div class="emptyResource">
      {{'lang.noSentResource' | translate}}
    </div>
  }
  <div class="row" style="margin: 0px;">
    <div class="col-md-12" style="padding-bottom: 10px;">
      @if (sentResources.length > 0) {
        <mat-button-toggle-group class="filterTypes" (change)="filterType($event)">
          <mat-button-toggle [checked]="currentFilter === ''" [value]="''">{{'lang.all' | translate}}</mat-button-toggle>
          @for (type of filterTypes | sortBy : 'label'; track type) {
            <mat-button-toggle
              [checked]="currentFilter === type.id" [value]="type.id">{{type.label}}
            </mat-button-toggle>
          }
        </mat-button-toggle-group>
      }
    </div>
  </div>
  <mat-table #table [dataSource]="dataSource" matSort matSortActive="creationDate" matSortDirection="desc">
    <ng-container matColumnDef="creationDate">
      <mat-cell *matCellDef="let row" class="dataLine" [ngClass]="{'canManage' : row.canManage && row.status !== 'WAITING', 'waitingSent': row.status === 'WAITING'}" style="flex: 1;padding: 0px;flex-direction: column;" (click)="row.status === 'WAITING' ? $event.stopPropagation() : open(row)">
        <div class="subinfo">
          @if ((row.sendDate === null && row.status === 'SENT' && row.type == 'm2m_ARCHIVETRANSFER') || row.type != 'm2m_ARCHIVETRANSFER') {
            <span style="flex:1" [title]="row.creationDate | fullDate">
              {{row.type == 'm2m_ARCHIVETRANSFER' ? ('lang.sent' | translate) : ('lang.createdAlt' | translate)}} : <b>{{row.creationDate | timeAgo : 'full'}}</b>
            </span>
          }
          @if (row.sendDate !== null) {
            <span style="flex:1;color:green" [title]="row.sendDate | fullDate">
              {{row.type == 'm2m_ARCHIVETRANSFER' ? 'Reçu' : 'lang.sent' | translate}} : <b>{{row.sendDate | timeAgo : 'full'}}</b>
            </span>
          }
          @if (row.status === 'DRAFT') {
            <span style="flex:1;color:orange">
              {{'lang.draft' | translate}}
            </span>
          }
          @if (row.sendDate === null && row.status === 'SENT') {
            <span style="flex:1;color:orange">
              En attente de réception
            </span>
          }
          @if (row.status === 'WAITING') {
            <span style="flex:1;color:orange;font-weight: bold;">
              {{'lang.emailSendInProgressShort' | translate}}
            </span>
          }
          @if (row.status === 'ERROR') {
            <span style="flex:1;color:red;font-weight: bold;">
              {{'lang.notSent' | translate}}
            </span>
          }
          @if (row.status !== 'ERROR' && row.type == 'acknowledgementReceipt' && functions.empty(row.sendDate)) {
            <span style="flex:1;color:orange">
              {{'lang.manualSendingAR' | translate}}
            </span>
          }
          @if (!functions.empty(row.operationDate)) {
            <span style="flex:1;color:green" [title]="row.operationDate | fullDate">
              {{'lang.delivery' | translate}} : <b>{{row.operationDate | timeAgo : 'full'}}</b>
            </span>
          }
        </div>
        <div style="display: grid;grid-template-columns: 100px 1fr 170px;width: 100%;grid-gap: 10px;align-items: center;padding:10px;">
          <div class="dateType">
            <span class="type">
              <span class="badge" [style.background]="row.typeColor" [title]="'lang.' + row.type | translate">{{'lang.' + row.type | translate}}</span>
              <div class="attach">
                @if (row.hasMainDoc) {
                  <i class="fas fa-file" title="Document attaché"></i>
                }
                @if (row.hasAttach) {
                  <i class="fas fa-paperclip" title="Pièce(s) jointe(s) attachée(s)"></i>
                }
                @if (row.hasNote) {
                  <i class="fas fa-pen-square" title="Note(s) attachée(s)"></i>
                }
              </div>
            </span>
          </div>
          <div class="desc" [innerHTML]="row.desc"></div>
          <div class="contact">
            @if (row.sender) {
              <span style="white-space: pre;overflow: hidden;text-overflow: ellipsis;" [title]="row.sender">
                {{'lang.senderShort' | translate}} : {{row.sender}}
              </span>
            }
            <span style="white-space: pre;overflow: hidden;text-overflow: ellipsis;" [title]="row.recipients">
              {{'lang.recipientShort' | translate}} : {{row.recipients}}
            </span>
          </div>
        </div>
      </mat-cell>
    </ng-container>
    <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
  </mat-table>
  @if (editMode && privilegeService.hasCurrentUserPrivilege('sendmail')) {
    <button mat-fab class="addSentResource bg-primary" [title]="'lang.sendElement' | translate" (click)="openPromptMail()">
      <mat-icon style="height: auto;width: auto;" class="fa fa-plus"></mat-icon>
    </button>
  }
  @if (editMode && canSendNumericPackage()) {
    <button mat-fab class="addSentResource bg-primary" [title]="'lang.sendNumericPackage' | translate" (click)="openPromptNumericPackage()">
      <mat-icon style="height: auto;width: auto;font-size: 20px;">
        <i class="fas fa-envelope-open-text" style="left: -5px;position: relative;"></i>
        <i class="fas fa-wifi" style="position: absolute;font-size: 10px;transform: rotate(35deg);margin-left: -3px;margin-top: -3px;"></i>
      </mat-icon>
    </button>
  }
}
