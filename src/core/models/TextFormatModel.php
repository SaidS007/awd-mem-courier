<?php

/**
 * Copyright Maarch since 2008 under licence GPLv3.
 * See LICENCE.txt file at the root folder for more details.
 * This file is part of Maarch software.
 *
 */

/**
 * @brief Text Format Model
 * @author dev@maarch.org
 */

namespace SrcCore\models;

use DateTime;
use Exception;

class TextFormatModel
{
    /**
     * @param array $aArgs
     * @return string
     * @throws Exception
     */
    public static function normalize(array $aArgs): string
    {
        ValidatorModel::notEmpty($aArgs, ['string']);
        ValidatorModel::stringType($aArgs, ['string']);

        $a = 'ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõöøùúûýýþÿŔŕ';
        $b = 'aaaaaaaceeeeiiiidnoooooouuuuybsaaaaaaaceeeeiiiidnoooooouuuyybyRr';

        $string = mb_convert_encoding($aArgs['string'], 'ISO-8859-1', 'UTF-8');
        $string = strtr($string, mb_convert_encoding($a,'ISO-8859-1', 'UTF-8'), $b);
        $string = strtolower($string);

        return mb_convert_encoding($string, 'UTF-8', 'ISO-8859-1');
    }

    /**
     * @param array $args
     * @return string|null
     * @throws Exception
     */
    public static function formatFilename(array $args): string|null
    {
        ValidatorModel::stringType($args, ['filename']);

        if (!empty($args['maxLength'])) {
            $args['filename'] = mb_substr($args['filename'], 0, $args['maxLength']);
        }

        $args['filename'] = str_replace(["\r\n", "\n", "\r"], "_", $args['filename']); // EDISSYUM - LBE01 - FIX Maarch 2301.3.4 - Correction erreur RFC 7230 | ajouter la ligne

        return preg_replace(mb_convert_encoding('@[\\/:*?"\'<>|,]@', 'ISO-8859-1', 'UTF-8'), '_', $args['filename']);
    }

    /**
     * @param $date
     * @param $format
     * @return string
     * @throws Exception
     */
    public static function formatDate($date, $format = null): string
    {
        if (empty($date)) {
            return '';
        }

        $date = new DateTime($date);

        if (!empty($format)) {
            return $date->format($format);
        }

        return $date->format('d-m-Y H:i');
    }

    /**
     * @param array $args
     * @return string
     * @throws Exception
     */
    public static function getEndDayDate(array $args): string
    {
        ValidatorModel::notEmpty($args, ['date']);
        ValidatorModel::stringType($args, ['date']);

        $date = new DateTime($args['date']);
        $date->setTime(23, 59, 59);

        return $date->format('d-m-Y H:i:s');
    }

    /**
     * @param array $aArgs
     * @return string
     * @throws Exception
     */
    public static function removeAccent(array $aArgs): string
    {
        ValidatorModel::notEmpty($aArgs, ['string']);
        ValidatorModel::stringType($aArgs, ['string', 'charset']);

        if (empty($aArgs['charset'])) {
            $aArgs['charset'] = 'utf-8';
        }

        $string = htmlentities($aArgs['string'], ENT_NOQUOTES, $aArgs['charset']);

        $string = preg_replace('#\&([A-za-z])(?:uml|circ|tilde|acute|grave|cedil|ring)\;#', '\1', $string);
        $string = preg_replace('#\&([A-za-z]{2})(?:lig)\;#', '\1', $string);
        $string = preg_replace('#\&[^;]+\;#', '', $string);

        return $string;
    }

    /**
     * @param $html
     * @return array|string|string[]
     */
    public static function htmlWasher($html): array|string
    {
        $html = str_replace("<br/>", "\\n", $html);
        $html = str_replace("<br />", "\\n", $html);
        $html = str_replace("<br/>", "\\n", $html);
        $html = str_replace("&nbsp;", " ", $html);
        $html = str_replace("&eacute;", "\u00e9", $html);
        $html = str_replace("&egrave;", "\u00e8", $html);
        $html = str_replace("&ecirc;", "\00ea", $html);
        $html = str_replace("&agrave;", "\u00e0", $html);
        $html = str_replace("&acirc;", "\u00e2", $html);
        $html = str_replace("&icirc;", "\u00ee", $html);
        $html = str_replace("&ocirc;", "\u00f4", $html);
        $html = str_replace("&ucirc;", "\u00fb", $html);
        $html = str_replace("&acute;", "\u0027", $html);
        $html = str_replace("&deg;", "\u00b0", $html);
        $html = str_replace("&rsquo;", "\u2019", $html);

        return $html;
    }

    /**
     * @param array $aArgs
     * @return string
     * @throws Exception
     */
    public static function cutString(array $aArgs): string
    {
        ValidatorModel::notEmpty($aArgs, ['string']);
        ValidatorModel::stringType($aArgs, ['string']);
        ValidatorModel::intType($aArgs, ['max']);

        $string = $aArgs['string'];
        $max = $aArgs['max'];
        if (strlen($string) >= $max) {
            $string = substr($string, 0, $max);
            $espace = strrpos($string, " ");
            $string = substr($string, 0, $espace) . "...";
            return $string;
        } else {
            return $string;
        }
    }

    /**
     * @param $subject
     * @return array|string|string[]
     */
    public static function snakeToCamel($subject): array|string
    {
        $subject = lcfirst(ucwords($subject, '_'));
        $subject = str_replace('_', '', $subject);
        return $subject;
    }

    /**
     * @param $subject
     * @return string
     */
    public static function camelToSnake($subject): string
    {
        $snakeCaseSubject = '';
        foreach (str_split($subject) as $index => $character) {
            if ($index > 0 && strtoupper($character) == $character && !str_contains('0123456789_', $character)) {
                $character = strtolower($character);
                $character = '_' . $character;
            }
            $snakeCaseSubject .= $character;
        }
        return $snakeCaseSubject;
    }
}
