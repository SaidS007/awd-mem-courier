version: '3.8'

services:
  db-mc:
    image: postgres:16-alpine
    restart: unless-stopped
    command: ["-c", "datestyle=iso,dmy"]
    volumes:
      - db-data:/var/lib/postgresql/data
      - sql_path:/home/sql
      - script_path:/home/scripts
    environment:
      POSTGRES_DB: ${DB_NAME:-mem}
      POSTGRES_USER: ${DB_USER:-edissyum}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-edissyum}
      POSTGRES_HOST_AUTH_METHOD: "trust"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-edissyum} -d ${DB_NAME:-mem}"]
      interval: 10s
      timeout: 5s
      retries: 5

  app-mc:
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "healthcheck.sh" ]
      interval: 10s
      timeout: 10s
      retries: 3
      start_period: 5s
    volumes:
      # Volumes persistants pour MEM
      - ${DOCSERVERS_ROOT_PATH:-./docservers}:/opt/maarch/docservers:rw
      - ${CUSTOM_PATH:-./custom}:/var/www/html/MaarchCourrier/custom:rw
      - sql_path:/var/www/html/MaarchCourrier/sql:rw
      - script_path:/home/scripts
      - ${LIBRAIRIES_PATH:-./librairies}:/app/librairies
      - ${CRON_CONFIGURATION_PATH:-./cron.d}:/etc/cron.d
      
      # Volumes persistants pour Open-Capture
      - opencapture_data:/var/www/html/opencapture:rw
      - opencapture_docservers:/var/docservers/opencapture:rw
      - opencapture_share:/var/share:rw
      - opencapture_venv:/home/www-data/python-venv/opencapture:rw
      - opencapture_logs:/var/www/html/opencapture/custom/mycompany/data/log:rw
      
      # Volume pour les donn√©es temporaires
      - temp_data:/tmp:rw
    ports:
      - ${APP_PORT:-8080}:80
    environment:
      LIBRARIES_DIR: /app/librairies
      MAARCH_TMP_DIR: ${MAARCH_TMP_DIR:-/tmp/maarch}
      DB_HOST: db-mc
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-mem}
      DB_USER: ${DB_USER:-edissyum}
      DB_PASSWORD: ${DB_PASSWORD:-edissyum}
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT:-993}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      OPENCAPTURE_INSTALLED: ${OPENCAPTURE_INSTALLED:-false}
    depends_on:
      db-mc:
        condition: service_healthy

volumes:
  # Volumes pour MEM
  db-data:
  sql_path:
  script_path:
  
  # Volumes pour Open-Capture
  opencapture_data:
  opencapture_docservers:
  opencapture_share:
  opencapture_venv:
  opencapture_logs:
  
  # Volume temporaire
  temp_data:
