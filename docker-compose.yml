version: '3.8'

services:
  db-mc:
    image: postgres:16-alpine
    container_name: db-mc
    #restart: unless-stopped
    command: ["-c", "datestyle=iso,dmy"]
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./sql:/docker-entrypoint-initdb.d
    ports:
      - "${DB_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: ${DB_NAME:-mem}
      POSTGRES_USER: ${DB_USER:-memuser}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-mempassword}
      POSTGRES_HOST_AUTH_METHOD: "trust"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-memuser} -d ${DB_NAME:-mem}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mem-opencapture-net

  app-mc:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: app-mc-opencap
    #restart: unless-stopped
    #healthcheck:
    #  test: ["CMD", "/home/scripts/healthcheck.sh"]
    #  interval: 30s
    #  timeout: 10s
    #  retries: 3
    #  start_period: 40s
    volumes:
      # Volumes pour MEM Courrier
      - mem-data:/var/www/html/MaarchCourrier
      - docservers-data:/opt/maarch/docservers
      - mem-logs:/var/log/maarch
      - ./custom:/var/www/html/MaarchCourrier/custom
      - ./cron.d:/etc/cron.d
      
      # Volumes pour Open-Capture
      - opencapture-data:/var/www/html/opencapture
      - opencapture-docservers:/var/docservers/opencapture
      - opencapture-share:/var/share
      - opencapture-logs:/var/log/opencapture
    ports:
      - "${APP_PORT:-8080}:80"
    environment:
      # Base de donn√©es
      DB_HOST: db-mc
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-mem}
      DB_USER: ${DB_USER:-memuser}
      DB_PASSWORD: ${DB_PASSWORD:-mempassword}
      
      # Configuration MEM
      MEM_VERSION: 2505
      MEM_PATH: /var/www/html/MaarchCourrier
      DOCSERVERS_PATH: /opt/maarch/docservers
      
      # Configuration email
      EMAIL_HOST: ${EMAIL_HOST}
      EMAIL_PORT: ${EMAIL_PORT:-993}
      EMAIL_USER: ${EMAIL_USER}
      EMAIL_PASSWORD: ${EMAIL_PASSWORD}
      
      # Configuration Open-Capture
      OPENCAPTURE_PATH: /var/www/html/opencapture
      CUSTOM_ID: ${CUSTOM_ID:-mycompany}
      OPENCAPTURE_INSTALLED: ${OPENCAPTURE_INSTALLED:-false}
    depends_on:
      db-mc:
        condition: service_healthy
    networks:
      - mem-opencapture-net

volumes:
  # Volumes pour MEM Courrier
  db-data:
  mem-data:
  docservers-data:
  mem-logs:
  
  # Volumes pour Open-Capture
  opencapture-data:
  opencapture-docservers:
  opencapture-share:
  opencapture-logs:
  
networks:
  mem-opencapture-net:
    driver: bridge
